<?xml version="1.0" encoding="UTF-8"?>
<HBRRepo>
  <variables>
    <variable id="1" name="ВЕРСИЯ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Version</property>
      <property name="prompt_text">Выберите Версию</property>
      <property name="scope">ruleset</property>
      <value>Рабочая_1</value>
    </variable>
    <variable id="2" name="ПЕРИОД" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Period</property>
      <property name="prompt_text">Выберите период</property>
      <property name="scope">ruleset</property>
      <value>"Итого год"</value>
    </variable>
    <variable id="3" name="ГОД" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Year</property>
      <property name="prompt_text">Выберите Год</property>
      <property name="scope">ruleset</property>
      <value>FY18</value>
    </variable>
    <variable id="4" name="СЦЕНАРИЙ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Scenario</property>
      <property name="prompt_text">Выберите Сценарий</property>
      <property name="scope">ruleset</property>
      <value>Проект</value>
    </variable>
    <variable id="5" name="МВЗ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimension">МВЗ</property>
      <property name="dimensionInputMode">name</property>
      <property name="prompt_text">Выберите МВЗ</property>
      <property name="scope">ruleset</property>
      <value>"Итого по МВЗ"</value>
    </variable>
  </variables>
  <rulesets></rulesets>
  <rules>
    <rule id="1" name="2.1.2.1.Ввод нормативов на 1 т чугуна" product="Planning">
      <property name="description">Расчет нормативов на 1 т чугуна</property>
      <property name="application">ТЧМ</property>
      <property name="plantype">Plan1</property>
      <property name="display_label">2.1.2.1.Ввод нормативов на 1 т чугуна</property>
      <property name="enableNotifications">false</property>
      <property name="enablePostProcessing">false</property>
      <property name="enablePreProcessing">false</property>
      <variable_references>
        <variable_reference id="1" name="ВЕРСИЯ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.2.1.Ввод нормативов на 1 т чугуна</property>
          <property name="seq">1</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="3" name="ГОД">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.2.1.Ввод нормативов на 1 т чугуна</property>
          <property name="seq">2</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="5" name="МВЗ">
          <property name="hasvalue">true</property>
          <property name="hidden">true</property>
          <property name="rule_name">2.1.2.1.Ввод нормативов на 1 т чугуна</property>
          <property name="seq">3</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">true</property>
          <property name="value">"Доменные печи"</property>
        </variable_reference>
        <variable_reference id="4" name="СЦЕНАРИЙ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.2.1.Ввод нормативов на 1 т чугуна</property>
          <property name="seq">4</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="2" name="ПЕРИОД">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.2.1.Ввод нормативов на 1 т чугуна</property>
          <property name="seq">5</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
      </variable_references>
      <script><![CDATA[SET AGGMISSG ON;
SET UPDATECALC OFF;
SET CREATEBLOCKONEQ OFF;
SET CREATENONMISSINGBLK OFF;
SET FRMLBOTTOMUP OFF;
SET REMOTECALC OFF;
SET CALCPARALLEL 1;
SET CALCTASKDIMS 1;
SET EMPTYMEMBERSETS ON;
SET FRMLRTDYNAMIC OFF;
SET MSG INFO;
/* Проверка корректности рассчитываемого среза данных */

FIX(
/* ВАЛЮТА							*/	"бу валюты"
/* ПЕРИОД							*/	"P0"
/* ГОД								*/	"No Year"
/* ВЕРСИЯ							*/	
/* СЦЕНАРИЙ							*/	
/* ЦФО								*/	"бу ЦФО"
/* МВЗ								*/	"бу МВЗ"
/* МВЗ ПОЛУЧАТЕЛЬ					*/	"бу МВЗ (пол-ль)"
/* СЧЕТА БАЛАНСА					*/	"80_Увеличение"
/* СТАТЬИ							*/	
/* ПОКАЗАТЕЛИ						*/	"Сумма"
/* ВИД ЗАТРАТ						*/	"бу видов затрат"
/* ПРОДУКЦИЯ						*/	"бу вида продукции"
/* КОНТРАГЕНТЫ						*/	"бу контрагента"
/* НАПРАВЛЕНИЕ	*/	"бу направления"
/* ЭЛЕМЕНТЫ_ЗАТРАТ					*/	"бу элемента затрат"
/* ПРОЧЕЕ							*/	"бу прочих справочников"

)
  SET CREATENONMISSINGBLK ON;

  
  var ErrFlagScenario=0;
  var ErrFlagVersion=0;
  var NextM=2;
  /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА СЦЕНАРИЯ */
  FIX(/* Сценарий */ {СЦЕНАРИЙ} AND @LIST(&ОТКРЫТЫЕ_СЦЕНАРИИ))
    FIX(
    /* Сценарий */ 
    /* Версия   */ "Рабочая 1"
    )
     "бу статьи" (
     IF (ErrFlagScenario==0)
            ErrFlagScenario=1;
     ENDIF
     );

    ENDFIX
  ENDFIX

   /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА ВЕРСИИ */
  FIX(/* Версия  */ {ВЕРСИЯ} AND @LIST(&ОТКРЫТЫЕ_ВЕРСИИ))
    FIX(
    /* Сценарий */ "Проект"
    /* Версия   */ 
    )
     "бу статьи" (
     IF (ErrFlagVersion==0)
            ErrFlagVersion=1;
     ENDIF
     );
    ENDFIX
  ENDFIX

  /* ВЫВОД СООБЩЕНИЙ О НЕКОРРЕКТНОМ СРЕЗЕ */
  FIX(
  /* Сценарий     */ "Проект"
  /* Версия       */ "Рабочая 1"
  )

   "бу статьи" (
    IF (ErrFlagScenario==0)
       @RETURN("Выбран сценарий, закрытый для расчета. Расчет не произведен.",ERROR);
    ENDIF
    IF (ErrFlagVersion==0)
       @RETURN("Выбрана версия, закрытая для расчета. Расчет не произведен.",ERROR);
    ENDIF
    )

   ENDFIX
ENDFIX
SET CREATENONMISSINGBLK OFF;
FIX(
/*МВЗ ПОЛУЧАТЕЛЬ            */"бу МВЗ (пол-ль)"
/*НАПРАВЛЕНИЕ   			*/"бу направления"
/*КОНТРАГЕНТЫ               */"бу контрагента"
/*ПРОЧЕЕ                  */"бу прочих справочников"
/*ВАЛЮТА                  */"RUR"
/*ЭЛЕМЕНТЫ_ЗАТРАТ            */"бу элемента затрат"
/*СЧЕТА БАЛАНСА               */"20_Начисление"
/*ЦФО                     */"ПТО"
/*ВЕРСИЯ                  */{ВЕРСИЯ}
/*ПЕРИОД                  */(@RELATIVE({ПЕРИОД},0) AND @RELATIVE("Итого год",0))
/*СЦЕНАРИЙ                  */{СЦЕНАРИЙ}
/*ГОД                     */{ГОД}
/*МВЗ                     */
/*ПРОДУКЦИЯ                  */
/*ВИД ЗАТРАТ               */
/*ПОКАЗАТЕЛИ               */
/*СТАТЬИ                  */                                                                     
)
SET CREATENONMISSINGBLK ON;
FIX(
/*МВЗ                     */@RELATIVE({МВЗ},0)
/*ПРОДУКЦИЯ                  */@RELATIVE("Чугун",0)
/*СТАТЬИ                  */"Топливо технологическое."
/*ПОКАЗАТЕЛИ               */"Норма на ед."                      
)
/*Создаем блоки*/

"Кокс влажный скиповой"(
"Кокс влажный скиповой" = "Кокс сухой скиповый"/((100-"Влага")/100);
)

/*Создаем блоки*/

"Коксовая мелочь с РВО"(
"Коксовая мелочь с РВО" = "Коксовая мелочь с РВО"->"ОПР ДП"->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПТО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"ОПР ДП (пол-ль)"->"Кол-во"->"RUR"
						/"Доменные печи"->"Чугун"->"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)";
)

/* Удалила коксовый орех с формы потому что оказалось, что норматив по нему не нужен - изменение от 19.01
"Коксовый орех с РВО"(
"Коксовый орех с РВО" = "Коксовый орех с РВО"->"ОПР ДП"->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПТО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"ОПР ДП (пол-ль)"->"Кол-во"->"RUR"
						/"Доменные печи"->"Чугун"->"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"
						- "Коксовый орех" ;


)*/

/*
"Кокс влажный скиповой"(
"Кокс влажный скиповой"="Кокс влажный скиповой"/"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"
                  -"Коксовый орех";
)
*/


"Кокс влажный металлургический" ="Кокс влажный скиповой"+"Коксовая мелочь с печей";

ENDFIX

FIX(
/*МВЗ                     */@RELATIVE({МВЗ},0)
/*ПРОДУКЦИЯ                  */@RELATIVE("Чугун",0)
/*СТАТЬИ                  */"Сырье и основные материалы."
/*ПОКАЗАТЕЛИ               */"Норма на ед."                      
)

/*
"Скрап переработанный"(
"Скрап переработанный"=@CREATEBLOCK("Металлодобавка в целом");
"Скрап переработанный"="Металлодобавка в целом"*"Скрап переработанный"->"Кол-во"/"Металлодобавка в целом"->"Кол-во";
)*/

/*пердаем на форму 2.1.2.2.Ввод количества выхода доменного газа
"Норматив выхода продукции"->"Металлодобавка в целом"
*/
"Металлодобавка в целом"(
@XWRITE(
(@SUMRANGE("Металлодобавка в целом",@RELATIVE("Чугун литейный",0))*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"->"Чугун литейный"+
@SUMRANGE("Металлодобавка в целом",@RELATIVE("Чугун передельный",0))*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"->"Чугун передельный"
)/"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"->"Чугун"
,@LOOPBACK,"Норматив выхода продукции","Металлодобавка в целом","Чугун в целом","ПТО","бу прочих справочников","бу направления","20_Начисление","бу элемента затрат","бу статьи"
);
)

/* досчитываем на форме 2.1.2.2. "Кол-во"*/
/*  "Металлодобавка в целом"(
@XWRITE(
"Кол-во"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"->"Скрап переработанный"+
"Кол-во"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"->"МК-50"+
"Кол-во"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"->"МК-250"+
"Кол-во"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"->"Шлак металлургический"
,@LOOPBACK,"Кол-во","Металлодобавка в целом","Чугун в целом","ПТО","бу прочих справочников","бу направления","20_Начисление","бу элемента затрат","бу статьи"
);
)*/

/* досчитываем на форме 2.1.2.2. "Кол-во" Выход доменного газа*/


/* ВОТ ЭТО ЗАДВАИВАЛО ВЫХОД ДОМЕННООГО ГАЗА. ЗАЧЕМ ОНО?
"Металлодобавка в целом"(
@XWRITE(
"Кол-во"->"Выход доменного газа"->"Чугун литейный в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"+
"Кол-во"->"Выход доменного газа"->"Чугун передельный в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
,@LOOPBACK,"Кол-во","Выход доменного газа","Чугун в целом","ПТО","бу прочих справочников","бу направления","20_Начисление","бу элемента затрат","бу статьи"
);
)*/

"Скрап переработанный"(
"Скрап переработанный"="Металлодобавка в целом"
*
"Кол-во"->"Скрап переработанный"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/
"Кол-во"->"Металлодобавка"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
;)

"МК-50"(
"МК-50"="Металлодобавка в целом"
*
"Кол-во"->"МК-50"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/
"Кол-во"->"Металлодобавка"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
;)

"МК-80"(
"МК-80"="Металлодобавка в целом"
*
"Кол-во"->"МК-80"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/
"Кол-во"->"Металлодобавка"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
;)

"МК-250"(
"МК-250"="Металлодобавка в целом"
*
"Кол-во"->"МК-250"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/
"Кол-во"->"Металлодобавка"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
;)


"Шлак металлургический"(

"Шлак металлургический"="Металлодобавка в целом"
*
"Кол-во"->"Шлак металлургический"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/
"Кол-во"->"Металлодобавка"->"Чугун в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
;)

ENDFIX



FIX(
/*МВЗ                     */@RELATIVE({МВЗ},0)
/*ПРОДУКЦИЯ                  */@RELATIVE("Чугун",0)
/*СТАТЬИ                  */"Сырье и основные материалы."
/*ПОКАЗАТЕЛИ               */
/*Вид затрат               */"Скрап переработанный","МК-50","МК-80","МК-250","Шлак металлургический"
)

"Кол-во" = "Норма на ед."*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)";
ENDFIX





FIX(
/*МВЗ                     */@RELATIVE({МВЗ},0)
/*ПРОДУКЦИЯ                  */@RELATIVE("Чугун",0)
/*СТАТЬИ                  */"Сырье и основные материалы."
/*ПОКАЗАТЕЛИ               */"Кол-во"
/*Вид затрат               */
)
/*
"Металлодобавка"(
"Металлодобавка"=@CREATEBLOCK("Металлодобавка в целом");
"Металлодобавка"="Металлодобавка в целом"->"Норма на ед."*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)";
)
*/
ENDFIX
/*Вспомогательный расчет */

FIX(
/*МВЗ                     */@RELATIVE({МВЗ},0)
/*ПРОДУКЦИЯ                  */@RELATIVE("Чугун",0)
/*СТАТЬИ                  */"бу статьи"
/*ПОКАЗАТЕЛИ               */"Кол-во"
/*Вид затрат               */

)



"Кокс влажный скиповой"(
"Кокс влажный скиповой"="Норма на ед."->"Кокс влажный скиповой"->"Топливо технологическое."*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)";
)

"Коксовый орех"(
"Коксовый орех"="Норма на ед."->"Коксовый орех"->"Топливо технологическое."*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)";
)

/*

"Проволока ПП"(

"Проволока ПП"="Норма на ед."->"Проволока ПП"->"Сырье и основные материалы."*"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)";
)

*/

ENDFIX

FIX(
/*МВЗ                     */@RELATIVE({МВЗ},0)
/*ПРОДУКЦИЯ                  */@RELATIVE("Чугун",0)
/*СТАТЬИ                  */"Энергозатраты по переделу"
/*ПОКАЗАТЕЛИ               */"Норма на ед."                      
)

/*"Кол-во"->"Выход доменного газа"->"Чугун в целом"->"ДП1"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
+"Кол-во"->"Выход доменного газа"->"Чугун в целом"->"ДП2"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
+"Кол-во"->"Выход доменного газа"->"Чугун в целом"->"ДП3"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
*/

"Очистка газа"(
IF(@ISDESC("Чугун литейный"))

(
"Кол-во"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"бу прочих справочников"->"бу вида продукции"->"ПТО"->"ОПР ДП"->"20_Выбытие"->"Газ доменный на каупера."->"Цехи п-п (сч 20;23;26)"->"Уч очистки доменного газа (пол-ль)"
*"Кол-во"->"Выход доменного газа"->"Чугун литейный в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/(
 
"Выход доменного газа"->"Доменные печи"->"Чугун литейный в целом"->"бу статьи"->"Кол-во"+
"Выход доменного газа"->"Доменные печи"->"Чугун передельный в целом"->"бу статьи"->"Кол-во"
 )
*
(
 "Кол-во"->"бу статьи"->"Кокс влажный скиповой"
+"Кол-во"->"бу статьи"->"Коксовый орех"
)
/
(
 @SUMRANGE("Кол-во"->"бу статьи"->"Кокс влажный скиповой",@RELATIVE("Чугун литейный",0))
+@SUMRANGE("Кол-во"->"бу статьи"->"Коксовый орех",@RELATIVE("Чугун литейный",0))
)
)
/
"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"
;
ELSEIF(@ISDESC("Чугун передельный"))


/*"Кол-во"->"Выход доменного газа"->"Чугун в целом"->"ДП1"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
+"Кол-во"->"Выход доменного газа"->"Чугун в целом"->"ДП2"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
+"Кол-во"->"Выход доменного газа"->"Чугун в целом"->"ДП3"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
*/



(
"Кол-во"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"бу прочих справочников"->"бу вида продукции"->"ПТО"->"ОПР ДП"->"20_Выбытие"->"Газ доменный на каупера."->"Цехи п-п (сч 20;23;26)"->"Уч очистки доменного газа (пол-ль)"
* "Кол-во"->"Выход доменного газа"->"Чугун передельный в целом"->"ПТО"->"бу прочих справочников"->"бу направления"->"20_Начисление"->"бу элемента затрат"->"бу статьи"
/( 
"Выход доменного газа"->"Доменные печи"->"Чугун литейный в целом"->"бу статьи"->"Кол-во"+
"Выход доменного газа"->"Доменные печи"->"Чугун передельный в целом"->"бу статьи"->"Кол-во"
)
*
(
 "Кол-во"->"бу статьи"->"Кокс влажный скиповой"
+"Кол-во"->"бу статьи"->"Коксовый орех"
)
/
(
 @SUMRANGE("Кол-во"->"бу статьи"->"Кокс влажный скиповой",@RELATIVE("Чугун передельный",0))
+ @SUMRANGE("Кол-во"->"бу статьи"->"Коксовый орех",@RELATIVE("Чугун передельный",0))
)
)
/
"Кол-во с учетом годного выхода"->"20_Выбытие"->"ПТО"->"бу статьи"->"бу видов затрат"->"Тов. пр-ция (сч 43)"
;
ENDIF;)



ENDFIX





ENDFIX]]></script>
    </rule>
  </rules>
  <components></components>
</HBRRepo>
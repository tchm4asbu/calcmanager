<?xml version="1.0" encoding="UTF-8"?>
<HBRRepo>
  <variables>
    <variable id="1" name="ГОД" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Year</property>
      <property name="prompt_text">Выберите Год</property>
      <property name="scope">ruleset</property>
      <value>FY18</value>
    </variable>
    <variable id="2" name="ПРОДУКЦИЯ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimension">ПРОДУКЦИЯ</property>
      <property name="dimensionInputMode">name</property>
      <property name="prompt_text">Выберите Продукцию</property>
      <property name="scope">ruleset</property>
      <value>"Итого по продукции"</value>
    </variable>
    <variable id="3" name="ВЕРСИЯ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Version</property>
      <property name="prompt_text">Выберите Версию</property>
      <property name="scope">ruleset</property>
      <value>Рабочая_1</value>
    </variable>
    <variable id="4" name="СЦЕНАРИЙ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Scenario</property>
      <property name="prompt_text">Выберите Сценарий</property>
      <property name="scope">ruleset</property>
      <value>Проект</value>
    </variable>
    <variable id="5" name="МВЗ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimension">МВЗ</property>
      <property name="dimensionInputMode">name</property>
      <property name="prompt_text">Выберите МВЗ</property>
      <property name="scope">ruleset</property>
      <value>"Итого по МВЗ"</value>
    </variable>
  </variables>
  <rulesets></rulesets>
  <rules>
    <rule id="1" name="1.3.5. Авансы" product="Planning">
      <property name="description">Авансы</property>
      <property name="application">ТЧМ</property>
      <property name="plantype">Plan1</property>
      <property name="display_label">1.3.5. Авансы</property>
      <property name="enablePostProcessing">false</property>
      <property name="enablePreProcessing">false</property>
      <variable_references>
        <variable_reference id="3" name="ВЕРСИЯ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">1.3.5. Авансы</property>
          <property name="seq">1</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="1" name="ГОД">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">1.3.5. Авансы</property>
          <property name="seq">2</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="5" name="МВЗ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">1.3.5. Авансы</property>
          <property name="seq">3</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="4" name="СЦЕНАРИЙ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">1.3.5. Авансы</property>
          <property name="seq">4</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="2" name="ПРОДУКЦИЯ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">1.3.5. Авансы</property>
          <property name="seq">5</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
      </variable_references>
      <script><![CDATA[SET AGGMISSG ON;
SET UPDATECALC OFF;
SET CREATEBLOCKONEQ OFF;
SET CREATENONMISSINGBLK OFF;
SET FRMLBOTTOMUP OFF;
SET REMOTECALC OFF;
SET CALCPARALLEL 1;
SET CALCTASKDIMS 1;
SET EMPTYMEMBERSETS ON;
SET FRMLRTDYNAMIC OFF;
SET MSG INFO;
/* Проверка корректности рассчитываемого среза данных */

FIX(
/* ВАЛЮТА							*/	"бу валюты"
/* ПЕРИОД							*/	"P0"
/* ГОД								*/	"No Year"
/* ВЕРСИЯ							*/	
/* СЦЕНАРИЙ							*/	
/* ЦФО								*/	"бу ЦФО"
/* МВЗ								*/	"бу МВЗ"
/* МВЗ ПОЛУЧАТЕЛЬ					*/	"бу МВЗ (пол-ль)"
/* СЧЕТА БАЛАНСА					*/	"80_Увеличение"
/* СТАТЬИ							*/	
/* ПОКАЗАТЕЛИ						*/	"Сумма"
/* ВИД ЗАТРАТ						*/	"бу видов затрат"
/* ПРОДУКЦИЯ						*/	"бу вида продукции"
/* КОНТРАГЕНТЫ						*/	"бу контрагента"
/* НАПРАВЛЕНИЕ	*/	"бу направления"
/* ЭЛЕМЕНТЫ_ЗАТРАТ					*/	"бу элемента затрат"
/* ПРОЧЕЕ							*/	"бу прочих справочников"

)
  SET CREATENONMISSINGBLK ON;

  
  var ErrFlagScenario=0;
  var ErrFlagVersion=0;
  var NextM=2;
  /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА СЦЕНАРИЯ */
  FIX(/* Сценарий */ {СЦЕНАРИЙ} AND @LIST(&ОТКРЫТЫЕ_СЦЕНАРИИ))
    FIX(
    /* Сценарий */ 
    /* Версия   */ "Рабочая 1"
    )
     "бу статьи" (
     IF (ErrFlagScenario==0)
            ErrFlagScenario=1;
     ENDIF
     );

    ENDFIX
  ENDFIX

   /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА ВЕРСИИ */
  FIX(/* Версия  */ {ВЕРСИЯ} AND @LIST(&ОТКРЫТЫЕ_ВЕРСИИ))
    FIX(
    /* Сценарий */ "Проект"
    /* Версия   */ 
    )
     "бу статьи" (
     IF (ErrFlagVersion==0)
            ErrFlagVersion=1;
     ENDIF
     );
    ENDFIX
  ENDFIX

  /* ВЫВОД СООБЩЕНИЙ О НЕКОРРЕКТНОМ СРЕЗЕ */
  FIX(
  /* Сценарий     */ "Проект"
  /* Версия       */ "Рабочая 1"
  )

   "бу статьи" (
    IF (ErrFlagScenario==0)
       @RETURN("Выбран сценарий, закрытый для расчета. Расчет не произведен.",ERROR);
    ENDIF
    IF (ErrFlagVersion==0)
       @RETURN("Выбрана версия, закрытая для расчета. Расчет не произведен.",ERROR);
    ENDIF
    )

   ENDFIX
ENDFIX
SET CREATENONMISSINGBLK OFF;
FIX(
/*МВЗ  									*/@LIST("ТЧМ в целом", "ТЧМС в целом") and @RELATIVE({МВЗ},0)
)
FIX(
/*ПРОЧЕЕ 								*/"Распределение авансов (дп)", "Распределение авансов (дх)"
/*ПРОДУКЦИЯ  							*/{ПРОДУКЦИЯ}
/*НАПРАВЛЕНИЕ  		*/@Relative("Экспорт", 0)
/*ЭЛЕМЕНТЫ_ЗАТРАТ  						*/"бу элемента затрат"
/*МВЗ ПОЛУЧАТЕЛЬ  						*/
/*ВАЛЮТА  								*/
/*ПЕРИОД  								*/
/*КОНТРАГЕНТЫ  							*/"Прочие внешние"
/*ВЕРСИЯ	  							*/{ВЕРСИЯ}
/*ГОД  									*/{ГОД}
/*МВЗ  									*/
/*СЦЕНАРИЙ  							*/{СЦЕНАРИЙ}
/*ВИД ЗАТРАТ 							*/@Relative("Всего по складам",0)
/*ЦФО  									*/"Отд ВЭС"
/*СТАТЬИ  								*/
/*ПОКАЗАТЕЛИ  							*/
/*СЧЕТА БАЛАНСА  						*/
)

FIX(
/*ПЕРИОД  								*/@Relative("Всего год",0), "P0"
/*МВЗ ПОЛУЧАТЕЛЬ  						*/@RELATIVE("Всего по курсам",0)
/*ВАЛЮТА  								*/ "USD", "EUR"
/*СТАТЬИ  								*/"месяц н.о."
/*СЧЕТА БАЛАНСА  						*/"Общая предоплата"
)

"Сумма"(
IF ( "Кол-во" <>#missing AND  "Цена" <>#missing )
"Сумма" = "Кол-во"*"Цена";
ELSE
"Сумма" = #missing;
ENDIF
)
ENDFIX



FIX(
/*ПЕРИОД  								*/@Relative("Всего год",0), "P0"
/*МВЗ ПОЛУЧАТЕЛЬ  						*/@RELATIVE("Всего по курсам",0)
/*СТАТЬИ  								*/@Relative("Всего:",0)
/*ВАЛЮТА  								*/ "USD", "EUR"
/*СЧЕТА БАЛАНСА  						*/"Признание аванса (выручка)"

)

"Сумма" (
IF ( "Кол-во" <>#missing AND  "Цена" <>#missing )
"Сумма" =  "Кол-во" *  "Цена";
ELSE
"Сумма" = #missing;
ENDIF
)

ENDFIX

FIX(
/*ПЕРИОД  								*/@Relative("Всего год",0), "P0"
/*МВЗ ПОЛУЧАТЕЛЬ  						*/"бу курса"
/*СТАТЬИ  								*/"месяц н.о."
/*ВАЛЮТА  								*/ "USD", "EUR"
/*СЧЕТА БАЛАНСА  						*/
/*ПОКАЗАТЕЛИ  							*/"Кол-во", "Цена", "Сумма"

)


"Выручка с НДС"(
IF (@ISMBR("Сумма"))
"Выручка с НДС" = "62_Реализация с НДС"->"Всего по усл. поставки"->"Поступления от реализации осн продукции"->"бу МВЗ (пол-ль)";
ELSEIF (@ISMBR("Кол-во"))
"Выручка с НДС" = "62_Реализация без НДС"->"Всего по усл. поставки"->"Поступления от реализации осн продукции"->"бу МВЗ (пол-ль)";
ELSEIF (@ISMBR("Цена"))
"Выручка с НДС" = ("Цена с тарифом"->"62_Реализация без НДС"->"Усл. поставки CPT"->"Реализация осн продукции на экспорт"->"бу МВЗ (пол-ль)"+
 "Цена с тарифом"->"62_Реализация без НДС"->"Усл. поставки CPT"->"Реализация осн продукции в СНГ"->"бу МВЗ (пол-ль)");
ENDIF
)



"Выручка в счет аванса"(
IF(@ISMBR("Январь"))
"Признание аванса (выручка)"->"Всего по курсам" ->"январь."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"январь."->"Январь";
ELSEIF(@ISMBR("Февраль"))
"Признание аванса (выручка)"->"Всего по курсам" ->"февраль."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"февраль."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"февраль."->"Февраль";
ELSEIF(@ISMBR("Март"))
"Признание аванса (выручка)"->"Всего по курсам" ->"март."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"март."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"март."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"март."->"Март";
ELSEIF(@ISMBR("Апрель"))
"Признание аванса (выручка)"->"Всего по курсам" ->"апрель."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"апрель."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"апрель."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"апрель."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"апрель."->"Апрель";
ELSEIF(@ISMBR("Май"))
"Признание аванса (выручка)"->"Всего по курсам" ->"май."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"май."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"май."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"май."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"май."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"май."->"Май";
ELSEIF(@ISMBR("Июнь"))
"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июнь."->"Июнь";
ELSEIF(@ISMBR("Июль"))
"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Июнь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"июль."->"Июль";
ELSEIF(@ISMBR("Август"))
"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Июнь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Июль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"август."->"Август";
ELSEIF(@ISMBR("Сентябрь"))
"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Июнь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Июль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Август"
+"Признание аванса (выручка)"->"Всего по курсам" ->"сентябрь."->"Сентябрь";
ELSEIF(@ISMBR("Октябрь"))
"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Июнь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Июль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Август"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Сентябрь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"октябрь."->"Октябрь";
ELSEIF(@ISMBR("Ноябрь"))
"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Июнь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Июль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Август"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Сентябрь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Октябрь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"ноябрь."->"Ноябрь";
ELSEIF(@ISMBR("Декабрь"))
"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"P0" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Январь" 
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Февраль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Март"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Апрель"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Май"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Июнь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Июль"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Август"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Сентябрь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Октябрь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Ноябрь"
+"Признание аванса (выручка)"->"Всего по курсам" ->"декабрь."->"Декабрь";
ENDIF
)

"Выручка в счет постоплаты"(
IF(@ISMBR("Январь":"декабрь"))
"Выручка в счет постоплаты"= "Выручка с НДС" - "Выручка в счет аванса";
ENDIF
)

"Аванс на конец"(
IF (@ISMBR("Кол-во") OR @ISMBR("Сумма"))  
"Аванс на конец"= @PRIOR("Аванс на конец") + "Признание аванса (выручка)"->"Всего по курсам"->"Всего:" - "Выручка в счет аванса";
ELSEIF (@ISMBR("Цена"))  
"Аванс на конец"->"Цена"= "Аванс на конец"->"Сумма"/"Аванс на конец"->"Кол-во";
ENDIF
)

ENDFIX

FIX(
/*ПЕРИОД  								*/@Relative("Всего год",0), "P0"
/*МВЗ ПОЛУЧАТЕЛЬ  						*/"бу курса"
/*СТАТЬИ  								*/"месяц н.о."
/*ВАЛЮТА  								*/ "USD", "EUR"
/*СЧЕТА БАЛАНСА  						*/"Выручка в счет аванса", "Выручка с НДС","Аванс на конец"
/*ПОКАЗАТЕЛИ  							*/
)

"Курс за период"(
"Курс за период" = "Сумма"->"Рубль"/ "Сумма";
)

ENDFIX



FIX(
/*ПЕРИОД  								*/@Relative("Всего год",0), "P0"
/*МВЗ ПОЛУЧАТЕЛЬ  						*/"бу курса"
/*СТАТЬИ  								*/"месяц н.о."
/*ВАЛЮТА  								*/ "USD", "EUR"
/*СЧЕТА БАЛАНСА  						*/"Выручка в счет аванса","Выручка в счет постоплаты","Аванс на конец"
/*ПОКАЗАТЕЛИ  							*/
)

"Цена"(
"Цена" = "Сумма"/"Кол-во";
)

ENDFIX
ENDFIX
ENDFIX]]></script>
    </rule>
  </rules>
  <components></components>
</HBRRepo>
<?xml version="1.0" encoding="UTF-8"?>
<HBRRepo>
  <variables>
    <variable id="1" name="ГОД" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Year</property>
      <property name="prompt_text">Выберите Год</property>
      <property name="scope">ruleset</property>
      <value>FY18</value>
    </variable>
    <variable id="2" name="ВЕРСИЯ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Version</property>
      <property name="prompt_text">Выберите Версию</property>
      <property name="scope">ruleset</property>
      <value>Рабочая_1</value>
    </variable>
    <variable id="3" name="СЦЕНАРИЙ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Scenario</property>
      <property name="prompt_text">Выберите Сценарий</property>
      <property name="scope">ruleset</property>
      <value>Проект</value>
    </variable>
  </variables>
  <rulesets></rulesets>
  <rules>
    <rule id="1" name="02.12.03.Калькуляция СПЦ" product="Planning">
      <property name="description">02.12.03.Калькуляция СПЦ</property>
      <property name="application">ТЧМ</property>
      <property name="plantype">Plan1</property>
      <property name="display_label">02.12.03.Калькуляция СПЦ</property>
      <property name="enableNotifications">false</property>
      <property name="enablePostProcessing">false</property>
      <property name="enablePreProcessing">false</property>
      <variable_references>
        <variable_reference id="2" name="ВЕРСИЯ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">02.12.03.Калькуляция СПЦ</property>
          <property name="seq">1</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="1" name="ГОД">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">02.12.03.Калькуляция СПЦ</property>
          <property name="seq">2</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="3" name="СЦЕНАРИЙ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">02.12.03.Калькуляция СПЦ</property>
          <property name="seq">3</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
      </variable_references>
      <script><![CDATA[SET AGGMISSG ON;
SET UPDATECALC OFF;
SET CREATEBLOCKONEQ OFF;
SET CREATENONMISSINGBLK OFF;
SET FRMLBOTTOMUP OFF;
SET REMOTECALC OFF;
SET CALCPARALLEL 1;
SET CALCTASKDIMS 1;
SET EMPTYMEMBERSETS ON;
SET FRMLRTDYNAMIC OFF;
SET MSG INFO;
/* Проверка корректности рассчитываемого среза данных */

FIX(
/* ВАЛЮТА							*/	"бу валюты"
/* ПЕРИОД							*/	"P0"
/* ГОД								*/	"No Year"
/* ВЕРСИЯ							*/	
/* СЦЕНАРИЙ							*/	
/* ЦФО								*/	"бу ЦФО"
/* МВЗ								*/	"бу МВЗ"
/* МВЗ ПОЛУЧАТЕЛЬ					*/	"бу МВЗ (пол-ль)"
/* СЧЕТА БАЛАНСА					*/	"80_Увеличение"
/* СТАТЬИ							*/	
/* ПОКАЗАТЕЛИ						*/	"Сумма"
/* ВИД ЗАТРАТ						*/	"бу видов затрат"
/* ПРОДУКЦИЯ						*/	"бу вида продукции"
/* КОНТРАГЕНТЫ						*/	"бу контрагента"
/* НАПРАВЛЕНИЕ	*/	"бу направления"
/* ЭЛЕМЕНТЫ_ЗАТРАТ					*/	"бу элемента затрат"
/* ПРОЧЕЕ							*/	"бу прочих справочников"

)
  SET CREATENONMISSINGBLK ON;

  
  var ErrFlagScenario=0;
  var ErrFlagVersion=0;
  var NextM=2;
  /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА СЦЕНАРИЯ */
  FIX(/* Сценарий */ {СЦЕНАРИЙ} AND @LIST(&ОТКРЫТЫЕ_СЦЕНАРИИ))
    FIX(
    /* Сценарий */ 
    /* Версия   */ "Рабочая 1"
    )
     "бу статьи" (
     IF (ErrFlagScenario==0)
            ErrFlagScenario=1;
     ENDIF
     );

    ENDFIX
  ENDFIX

   /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА ВЕРСИИ */
  FIX(/* Версия  */ {ВЕРСИЯ} AND @LIST(&ОТКРЫТЫЕ_ВЕРСИИ))
    FIX(
    /* Сценарий */ "Проект"
    /* Версия   */ 
    )
     "бу статьи" (
     IF (ErrFlagVersion==0)
            ErrFlagVersion=1;
     ENDIF
     );
    ENDFIX
  ENDFIX

  /* ВЫВОД СООБЩЕНИЙ О НЕКОРРЕКТНОМ СРЕЗЕ */
  FIX(
  /* Сценарий     */ "Проект"
  /* Версия       */ "Рабочая 1"
  )

   "бу статьи" (
    IF (ErrFlagScenario==0)
       @RETURN("Выбран сценарий, закрытый для расчета. Расчет не произведен.",ERROR);
    ENDIF
    IF (ErrFlagVersion==0)
       @RETURN("Выбрана версия, закрытая для расчета. Расчет не произведен.",ERROR);
    ENDIF
    )

   ENDFIX
ENDFIX
SET CREATENONMISSINGBLK OFF;
/*Срез Смметы для зачистки*/
FIX(
/*ЭЛЕМЕНТЫ_ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 						*/"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */@REMOVE(@RELATIVE("Итого по видам затрат",0),@LIST("ФОТ.", "Страховые взносы","Разработка грунта","Водный налог","Расчеты по договорам за водопользование"))
/*СТАТЬИ							  */@RELATIVE("ПОЛНАЯ СЕБЕСТОИМОСТЬ",0),"Кол-во с учетом годного выхода."
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД								 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 								 */{ВЕРСИЯ}
/*ГОД 								 	 */{ГОД}
/*ПРОДУКЦИЯ 							 */@RELATIVE("Всего по продукции",0) and @RELATIVE("Прокат",0)
/*ПОКАЗАТЕЛИ 						     */"Цена","Кол-во с учетом годного выхода"
/*МВЗ 									 */
)
FIXPARALLEL(8,@IDESCENDANTS("СПЦ"))
CLEARBLOCK ALL;
ENDFIXPARALLEL
ENDFIX
/*Агрегируем цены с 6.14*/
FIX(
/*ПРОЧЕЕ						*/"бу прочих справочников"
/*ПРОДУКЦИЯ                     */"бу вида продукции"
/*НАПРАВЛЕНИЕ       			*/"бу направления"
/*ЭЛЕМЕНТЫ_ЗАТРАТ               */"бу элемента затрат"
/*МВЗ ПОЛУЧАТЕЛЬ                */"бу МВЗ (пол-ль)"
/*ВАЛЮТА                        */"RUR"
/*ПЕРИОД                        */@RELATIVE("Всего год",0)
/*КОНТРАГЕНТЫ                   */
/*ВЕРСИЯ                        */{ВЕРСИЯ}
/*ГОД                           */{ГОД}
/*МВЗ                           */@ILDESCENDANTS(@LIST(@IANCESTORS("СПЦ",4),"бу МВЗ")) and  @RELATIVE("Всего по МВЗ",0)
/*СЦЕНАРИЙ                      */{СЦЕНАРИЙ}
/*ВИД ЗАТРАТ                    */"Электроэнергия покупная",
								"Водород",
								"Газ природный",
								"Газ природный (осн. объем)",
								"Газ природный (биржа)",
								"Техническое обслуживание газовых сетей",
								"Вода",
								"Стоки",
								"Аргон","Аргон.",
								"Кислород технологический",
								"Пар покупной","Азот газообразный","Техническая вода","Техническая вода подготовленная.","Питьевая вода","Сжатый воздух в целом"
/*ЦФО                           */
/*СТАТЬИ                        */"Энергоресурсы_", "Топливо.","Прочие выплаты (гр)"
/*ПОКАЗАТЕЛИ                    */"Кол-во","Сумма"
/*СЧЕТА БАЛАНСА                 */"60_Начисление без НДС"
)

FIX(
/*ЦФО                           */"ОСиТ","Коммерческая служба", "Упр по реал-ции прод-ции"
/*КОНТРАГЕНТЫ                   */
)
AGG("КОНТРАГЕНТЫ");/*"Контрагенты ТЧМ и ТЧМС"*/
ENDFIX

FIX(
/*ЦФО                           */
/*КОНТРАГЕНТЫ                   */"Контрагенты ТЧМ и ТЧМС"
)
AGG("ЦФО");/*"Центры финансовой ответсвенности"*/
ENDFIX

ENDFIX



FIX(
/*НАПРАВЛЕНИЕ          */
/*ПРОДУКЦИЯ                         */
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                      */"бу элемента затрат"
/*ЦФО                               */
/*ВАЛЮТА                            */"RUR","бу валюты"
/*КОНТРАГЕНТЫ                         */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*МВЗ                               */
/*СЧЕТА БАЛАНСА                      */
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */@RELATIVE("Итого по видам затрат",0)
/*СТАТЬИ                            */
/*ПЕРИОД                            */@RELATIVE("Итого год",0),"P0"
/*ПОКАЗАТЕЛИ                         */
)
/*Агрегируем цены 6-го блока*/

FIX(
/*ПРОДУКЦИЯ                         */"бу вида продукции"
/*МВЗ                               */"ТЧМ в целом","ТЧМС в целом"
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"10_Остаток на начало","10_Поступление","10_Остаток на конец"
/*СТАТЬИ                            */@CHILDREN("Отток денежных средств по текущей деятельности"),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Сумма","Кол-во"
)
FIX(
/*ЦФО                               */@RELATIVE("Итого по ЦФО",0)
)
AGG(КОНТРАГЕНТЫ);
ENDFIX

FIX(
/*КОНТРАГЕНТЫ                        */"Контрагенты ТЧМ и ТЧМС"
)
AGG(ЦФО);
ENDFIX
ENDFIX


/*Агрегируем нормативы */

FIX(
/*ПРОДУКЦИЯ                         */@RELATIVE("Всего по продукции",0) and @RELATIVE("Прокат",0)
/*МВЗ                               */@RELATIVE("СПЦ",0)
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во","Норма на ед.","Нормы сырья и топлива на 1 ед. измер.","Выход шлака на 1 т чугуна"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
AGG(ЦФО);
ENDFIX

/*Агрегируем ПП */

FIX(
/*ПРОДУКЦИЯ                         */@RELATIVE("Всего по продукции",0) and @RELATIVE("Прокат",0)
/*МВЗ                               */@RELATIVE("СПЦ",0)
/*НАПРАВЛЕНИЕ          */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*СЧЕТА БАЛАНСА                      */"20_Начисление","20_Выбытие","43_Производство ГП"
/*СТАТЬИ                            */"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во с учетом годного выхода"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
FIX(
/*НАПРАВЛЕНИЕ                         */@RELATIVE("Направления",0)
/*МВЗ ПОЛУЧАТЕЛЬ                      */@RELATIVE("Итого по МВЗ (пол-ль)",0)
)
AGG(ЦФО);
ENDFIX

FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*НАПРАВЛЕНИЕ          */
/*МВЗ ПОЛУЧАТЕЛЬ                      */@RELATIVE("Итого по МВЗ (пол-ль)",0)
)
AGG("НАПРАВЛЕНИЕ");
ENDFIX

FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*НАПРАВЛЕНИЕ                         */"Направления"
/*МВЗ ПОЛУЧАТЕЛЬ                      */
)
AGG("МВЗ ПОЛУЧАТЕЛЬ");
ENDFIX


ENDFIX
ENDFIX

/*Расчет основных показателей*/

FIX(
/*НАПРАВЛЕНИЕ          				*/
/*ПРОДУКЦИЯ                         */@REMOVE(@LIST(@ILDESCENDANTS("Прокат"),@RDESCENDANTS("Прокат")),@LIST("Условный газ","Кислород газообразный в баллонах.","Азот газообразный в баллонах_","бу вида продукции"))
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                   */"бу элемента затрат"
/*ЦФО                               */
/*ВАЛЮТА                            */
/*КОНТРАГЕНТЫ                         */"бу контрагента"
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*МВЗ                               */@RELATIVE("СПЦ",0)
/*СЧЕТА БАЛАНСА                      */
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */
/*СТАТЬИ                            */
/*ПЕРИОД                            */@RELATIVE("Итого год",0)
/*ПОКАЗАТЕЛИ                         */
)

/*Создаем блоки из нормативов для количества*/
FIX(
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*ВИД ЗАТРАТ                         */@REMOVE(@RELATIVE("Итого по видам затрат",0),@LIST("Разработка грунта", "Потери эл. энергии"))
/*СТАТЬИ                            */
) 
FIXPARALLEL(8,@DESCENDANTS("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ"))


DATACOPY "Кол-во"->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";

DATACOPY "Кол-во"->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";


DATACOPY "Кол-во"->"бу направления"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу направления"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу направления"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";

DATACOPY "Кол-во"->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";

ENDFIXPARALLEL

ENDFIX

/*Создаем блоки из нормативов для "Кол-во с учетом годного выхода"*/
FIX(
/*ВИД ЗАТРАТ                         */"бу видов затрат"
/*СТАТЬИ                            */
) 
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";


DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";


DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";

DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";


ENDFIX




FIX(
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*ВАЛЮТА                            */"RUR"
/*ЦФО                               */"ПЭО"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*НАПРАВЛЕНИЕ         				 */"бу направления"
/*ВИД ЗАТРАТ                         */
/*СТАТЬИ                            */
)


FIX(
/*ВИД ЗАТРАТ                         */"бу видов затрат"
/*СТАТЬИ                            */"Кол-во с учетом годного выхода."
)
/*Перенос "Кол-во с учетом годного выхода"*/
"Кол-во"(
"Кол-во" = #missing;
"Кол-во"=
"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"20_Выбытие"          
+"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"20_Выбытие"               
+"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"43_Производство ГП"
+"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"43_Производство ГП"          

;)





ENDFIX

FIX(
/*ВИД ЗАТРАТ                         */
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0)
)
FIXPARALLEL(8,@DESCENDANTS("Итого по видам затрат"))
/*Расчет количества по нормативу*/


"Кол-во"(
IF( ( @ISDESC("№17. Энергоцех") and @ISMBR("Разработка грунта"))
OR ( @ISMBR("Уч передачи электроэнергии") and @ISMBR(@LIST("Электроэнергия покупная",/*"Электроэнергия ТЭЦ-ПВС",*/"Потери эл. энергии" ))) 
/*or ( NOT @ISMBR("Уч пр-ва условного газа") and NOT @ISMBR(@LIST("Электроэнергия","Пар","Техническая вода")))*/  ) 
/*"Кол-во"=#missing;*/
"Кол-во";
ELSE 
"Кол-во"=
/*норматив*/
("Норма на ед."->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности"
+"Норма на ед."->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности"
+"Норма на ед."->"RUR"->"Центры финансовой ответсвенности"
+"Норма на ед."->"бу валюты"->"Центры финансовой ответсвенности"
/*Добавил для Аглоцеха*/
+"Нормы сырья и топлива на 1 ед. измер."->"бу направления"->"RUR"->"Центры финансовой ответсвенности"/1000
)
/*количество из ПП*/
*
(
"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат")
;

ENDIF)


"Цена"(
IF("Кол-во"+0>0)
IF( NOT @ISMBR("Отходы производства") and NOT @ISDESC("Возвратные отходы") )
IF(@ISMBR("Январь"))
/*цены на возвратные отходы из формы 6.08 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Цена"->"RUR"
+


/*цены с 6.04.03*/
/*вместо динамика Цена с тарифом. прописываем ее формулу*/
(
@SUMRANGE("Сумма"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Сумма"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
@SUMRANGE("Кол-во"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Кол-во"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)
+
/*цены с 6.14*/
/*цена в целом */
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/*зануляем цену если цена есть для конкретного МВЗ*/
 *(1-@POWER(1,@SUMRANGE("Цена"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))))
+
/*цена по конкретному мвз*/
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
;
ELSE 
/*цены на возвратные отходы из формы 6.08 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Цена"->"RUR"

+
/*цены с 6.04.03*/
(
@PRIOR("Сумма"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"->"Отток денежных средств по текущей деятельности")
+ @PRIOR("Сумма"->"бу статьи"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности")

+@SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
 @PRIOR("Кол-во"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"->"Отток денежных средств по текущей деятельности")
+ @PRIOR("Кол-во"->"бу статьи"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности")

+@SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)
+
/*цены с 6.14*/
/*цена в целом */
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/*зануляем цену если цена есть для конкретного МВЗ*/
*(1-@POWER(1,@SUMRANGE("Цена"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))))
+
/*цена по конкретному мвз*/
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))

;
ENDIF
ELSE 
/*цены на возвратные отходы из формы 6.08 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Цена"->"RUR"
+
/*цены на возвратные отходы из формы 1.6.1 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"Коммерческая служба"->"бу элемента затрат"->"бу статьи"->"бу счета баланса"->"бу МВЗ (пол-ль)"->"Цена"->"RUR";
ENDIF
ELSE 
"Цена" = #missing;
ENDIF;)




"Сумма"(
IF(
/*отключаем расчет сумма для след ВЗ и МВЗ ->Продкция*/
NOT @ISMBR("Разработка грунта"->"Уч транспортировки и очистки промливневых стоков"->"Прием пром-ливневых стоков")
AND NOT @ISMBR("Разработка грунта"->"Уч по разработке шлама аглодоменного"->"Шлам по ТУ 14-127-330.")
AND NOT @ISMBR("Разработка грунта"->"Уч питьевой воды"->"Питьевая вода.")
AND NOT @ISMBR("Разработка грунта"->"Уч перекачки и очистка хоз.-бытовых стоков"->"Хоз.-бытовые стоки")
AND NOT @ISMBR("Разработка грунта"->"Уч технической воды"->"Техническая вода.")
)

/*лоика следующая по зачистке сумм
Если Кол-во на ед, которая расчитана в прошлый раз <> 0, 
значит Сумма расчитана как Кол-во  * Цена
*/
IF("Кол-во на ед"!=#missing) 
"Сумма"="Цена"*"Кол-во";
ENDIF
ENDIF
;)

/*разносим "Кол-во с учетом годного выхода для расчета Кол-во и суммы  на ед в динамике */
"Кол-во с учетом годного выхода"(
	IF("Кол-во"!=#missing)
		"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";
	ELSE
		#missing;
ENDIF)

"Кол-во на ед"("Кол-во"/"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";)

"Сумма на ед"("Сумма"/"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";)

"Структура"("Сумма"/"Сумма"->"СЕБЕСТОИМОСТЬ ТОВАРНОЙ ПРОДУКЦИИ FCA"->"бу видов затрат";)

ENDFIXPARALLEL
ENDFIX
ENDFIX


ENDFIX

/*Удаляем не нужные агрегаты*/
FIX(
/*НАПРАВЛЕНИЕ          */
/*ПРОДУКЦИЯ                         */"бу вида продукции"
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                      */"бу элемента затрат"
/*ЦФО                               */
/*ВАЛЮТА                            */"RUR","бу валюты"
/*КОНТРАГЕНТЫ                         */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*МВЗ                               */
/*СЧЕТА БАЛАНСА                      */
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */@RELATIVE("Всего по видам затрат",0)
/*СТАТЬИ                            */
/*ПЕРИОД                            */@RELATIVE("Итого год",0),"P0"
/*ПОКАЗАТЕЛИ                         */
)
/*6-го блока*/

FIX(
/*МВЗ                               */"ТЧМ в целом","ТЧМС в целом"
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"10_Остаток на начало","10_Поступление","10_Остаток на конец"
/*СТАТЬИ                            */@CHILDREN("Отток денежных средств по текущей деятельности"),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Сумма","Кол-во"
)
FIX(
/*ЦФО                               */
/*КОНТРАГЕНТЫ                        */"Контрагенты ТЧМ и ТЧМС"
)
FIXPARALLEL(8,@IDESCENDANTS("Центры финансовой ответсвенности"))

CLEARBLOCK ALL;


ENDFIXPARALLEL
ENDFIX
ENDFIX


/*нормативы */

FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*МВЗ                               */
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во","Норма на ед.","Нормы сырья и топлива на 1 ед. измер.","Выход шлака на 1 т чугуна"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
FIXPARALLEL(8,@IDESCENDANTS("СПЦ"))
CLEARBLOCK ALL;
ENDFIXPARALLEL
ENDFIX

/* ПП */

FIX(
/*МВЗ                               */
/*НАПРАВЛЕНИЕ          */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*СЧЕТА БАЛАНСА                      */"20_Начисление","20_Выбытие","43_Производство ГП"
/*СТАТЬИ                            */"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во с учетом годного выхода"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*НАПРАВЛЕНИЕ                         */@RELATIVE("Направления",0),"Направления"
/*МВЗ ПОЛУЧАТЕЛЬ                      */@RELATIVE("Итого по МВЗ (пол-ль)",0),"МВЗ получатель"
)
FIXPARALLEL(8,@IDESCENDANTS("СПЦ"))
CLEARBLOCK ALL;
ENDFIXPARALLEL
ENDFIX


ENDFIX 
ENDFIX 


/*Удаляем агрегот для цены с 6.14*/
FIX(
/*ПРОЧЕЕ						*/"бу прочих справочников"
/*ПРОДУКЦИЯ                     */"бу вида продукции"
/*НАПРАВЛЕНИЕ       			*/"бу направления"
/*ЭЛЕМЕНТЫ_ЗАТРАТ               */"бу элемента затрат"
/*МВЗ ПОЛУЧАТЕЛЬ                */"бу МВЗ (пол-ль)"
/*ВАЛЮТА                        */"RUR"
/*ПЕРИОД                        */@RELATIVE("Всего год",0)
/*КОНТРАГЕНТЫ                   */
/*ВЕРСИЯ                        */{ВЕРСИЯ}
/*ГОД                           */{ГОД}
/*МВЗ                           */@RELATIVE("Всего по МВЗ",0)
/*СЦЕНАРИЙ                      */{СЦЕНАРИЙ}
/*ВИД ЗАТРАТ                    */"Электроэнергия покупная",
								"Водород",
								"Газ природный",
								"Газ природный (осн. объем)",
								"Газ природный (биржа)",
								"Техническое обслуживание газовых сетей",
								"Вода",
								"Стоки",
								"Аргон",
								"Кислород технологический",
								"Пар покупной","Азот газообразный","Техническая вода","Техническая вода подготовленная.","Питьевая вода"
/*ЦФО                           */
/*СТАТЬИ                        */"Энергоресурсы_", "Топливо.","Прочие выплаты (гр)"
/*ПОКАЗАТЕЛИ                    */"Кол-во","Сумма"
/*СЧЕТА БАЛАНСА                 */"60_Начисление без НДС"
)

FIX(
/*ЦФО                           */"ОСиТ","Коммерческая служба", "Упр по реал-ции прод-ции","Центры финансовой ответсвенности"
/*КОНТРАГЕНТЫ                   */"Контрагенты ТЧМ и ТЧМС"
)
CLEARBLOCK ALL;
ENDFIX

ENDFIX
/*Агрегируем поолную себестоимость*/

FIX(
/*ЭЛЕМЕНТЫ_ЗАТРАТ					 */
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 					 */"бу направления"
/*ПРОЧЕЕ 							 */
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */
/*СТАТЬИ							  */@RELATIVE("ПОЛНАЯ СЕБЕСТОИМОСТЬ",0)
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД							  */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 							  */{ВЕРСИЯ}
/*ГОД 								  */{ГОД}
/*ПРОДУКЦИЯ 						  */
/*ПОКАЗАТЕЛИ 						   */"Сумма","Кол-во"
/*МВЗ 									*/@RELATIVE("ККЦ",0)
)

FIX(
/*ПРОДУКЦИЯ 						  */@RELATIVE("Итого по продукции",0)	
/*ВИД ЗАТРАТ 						  */@RELATIVE("Всего по видам затрат",0)
/*ПРОЧЕЕ 							  */@RELATIVE("Итого по прочим справочникам",0)
/*ЭЛЕМЕНТЫ_ЗАТРАТ					  */
/*МВЗ ПОЛУЧАТЕЛЬ 					  */@RELATIVE("Итого по МВЗ (пол-ль)",0)
)

AGG("ЭЛЕМЕНТЫ_ЗАТРАТ");

ENDFIX


FIX(
/*ПРОДУКЦИЯ 						  */@RELATIVE("Итого по продукции",0)	
/*ВИД ЗАТРАТ 						  */@RELATIVE("Всего по видам затрат",0)
/*ПРОЧЕЕ 							  */
/*ЭЛЕМЕНТЫ_ЗАТРАТ					  */"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"
/*МВЗ ПОЛУЧАТЕЛЬ 					  */@RELATIVE("Итого по МВЗ (пол-ль)",0)
)

AGG("ПРОЧЕЕ");

ENDFIX

FIX(
/*ПРОДУКЦИЯ 						  */@RELATIVE("Итого по продукции",0)	
/*ВИД ЗАТРАТ 						  */@RELATIVE("Всего по видам затрат",0)
/*ПРОЧЕЕ 							  */"Прочие справочники ТЧМ И ТЧМС"
/*ЭЛЕМЕНТЫ_ЗАТРАТ					  */"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"
/*МВЗ ПОЛУЧАТЕЛЬ 					  */	
)

AGG("МВЗ ПОЛУЧАТЕЛЬ");

ENDFIX

FIX(
/*ПРОДУКЦИЯ 						  */	
/*ВИД ЗАТРАТ 						  */@RELATIVE("Всего по видам затрат",0)
/*ПРОЧЕЕ 							  */"Прочие справочники ТЧМ И ТЧМС"
/*ЭЛЕМЕНТЫ_ЗАТРАТ					  */"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"
/*МВЗ ПОЛУЧАТЕЛЬ 					  */"МВЗ получатели"	
)

AGG("ПРОДУКЦИЯ");

ENDFIX

FIX(
/*ПРОДУКЦИЯ 						  */@RELATIVE("Итого по продукции",0),"ПРОДУКЦИЯ ТЧМ и ТЧМС"	
/*ВИД ЗАТРАТ 						  */
/*ПРОЧЕЕ 							  */"Прочие справочники ТЧМ И ТЧМС"
/*ЭЛЕМЕНТЫ_ЗАТРАТ					  */"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"
/*МВЗ ПОЛУЧАТЕЛЬ 					  */"МВЗ получатели"	
)

AGG("ВИД_ЗАТРАТ");

ENDFIX
ENDFIX
FIX(
/*НАПРАВЛЕНИЕ          */"бу направления"
/*ПРОДУКЦИЯ                         */@RELATIVE("Прокат",0) 
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                      */"бу элемента затрат"
/*ЦФО                               */"ПЭО"
/*ВАЛЮТА                            */"RUR"
/*КОНТРАГЕНТЫ                         */"бу контрагента"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*МВЗ                               */@RELATIVE("СПЦ",0)
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */@RELATIVE("Итого по видам затрат",0)
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0)
/*ПЕРИОД                            */@RELATIVE("Итого год",0)
/*ПОКАЗАТЕЛИ                         */
)


"Сумма" (
IF(@ISMBR("Заготовка кв 150 (углерод.ст)"))      
"Заготовка кв 150 (углерод.ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв 150 (углерод.ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв 180 (углерод.ст)"))      
"Заготовка кв 180 (углерод.ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв 180 (углерод.ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  150 (низколег. ст)"))      
"Заготовка кв  150 (низколег. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  150 (низколег. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во" ->"бу видов затрат"* "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  180 (низколег. ст)"))      
"Заготовка кв  180 (низколег. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  180 (низколег. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  150 (низкоуглерод. ст)"))      
"Заготовка кв  150 (низкоуглерод. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  150 (низкоуглерод. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  180 (низкоуглерод. ст)"))      
"Заготовка кв  180 (низкоуглерод. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  180 (низкоуглерод. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  150 (констр. ст)"))      
"Заготовка кв  150 (констр. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  150 (констр. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  180 (констр. ст)"))      
"Заготовка кв  180 (констр. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  180 (констр. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  150 (высокоуглерод. ст)"))      
"Заготовка кв  150 (высокоуглерод. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  150 (высокоуглерод. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ELSEIF(@ISMBR("Заготовка кв  180 (высокоуглерод. ст)"))      
"Заготовка кв  180 (высокоуглерод. ст.)"->"ПОЛНАЯ СЕБЕСТОИМОСТЬ"->"Сумма"->"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"->"Уч непрерывной разливки стали"->"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"->"Прочие справочники ТЧМ И ТЧМС"->"20_Начисление"->"МВЗ получатели"
/"Уч непрерывной разливки стали"->"Заготовка кв  180 (высокоуглерод. ст.)"->"Кол-во с учетом годного выхода."->"Кол-во"->"бу видов затрат" * "Кол-во" ;
ENDIF
)

"Сумма на ед"("Сумма"/"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";)

ENDFIX

FIX (
/*НАПРАВЛЕНИЕ                       */"бу направления"
/*ПРОДУКЦИЯ                         */"бу вида продукции"
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                   */"бу элемента затрат"
/*ЦФО                               */"ОГЭ"
/*ВАЛЮТА                            */"RUR"
/*КОНТРАГЕНТЫ                       */"бу контрагента"
/*МВЗ ПОЛУЧАТЕЛЬ                    */"бу МВЗ (пол-ль)"
/*МВЗ                               */@RELATIVE("СПЦ",0)
/*СЧЕТА БАЛАНСА                     */"20_Начисление"
/*СЦЕНАРИЙ                          */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                        */@RELATIVE("Энергозатраты",0),"Газ природный"
/*СТАТЬИ                            */"Энергозатраты по переделу"
/*ПЕРИОД                            */@RELATIVE("Итого год",0)
/*ПОКАЗАТЕЛИ                        */
)

CLEARDATA "Кол-во";

ENDFIX;

FIX (
/*НАПРАВЛЕНИЕ                       */"бу направления"
/*ПРОДУКЦИЯ                         */@RELATIVE("Прокат",0)
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                   */"бу элемента затрат"
/*ЦФО                               */"ПЭО"
/*ВАЛЮТА                            */"RUR"
/*КОНТРАГЕНТЫ                       */"бу контрагента"
/*МВЗ ПОЛУЧАТЕЛЬ                    */"бу МВЗ (пол-ль)"
/*МВЗ                               */@RELATIVE("СПЦ",0)
/*СЧЕТА БАЛАНСА                     */"20_Начисление"
/*СЦЕНАРИЙ                          */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                        */@RELATIVE("Энергозатраты",0),"Газ природный"
/*СТАТЬИ                            */"Энергозатраты по переделу"
/*ПЕРИОД                            */@RELATIVE("Итого год",0)
/*ПОКАЗАТЕЛИ                        */
)
"Кол-во" ( 
    IF ("Кол-во" + 0 <> 0)
        "Кол-во"->"ОГЭ"->"бу вида продукции" = "Кол-во"->"ОГЭ"->"бу вида продукции" + "Кол-во";
    ENDIF;)
ENDFIX;
/*Удаляем агрегаты себестоимости*/

FIX(
/*ЭЛЕМЕНТЫ_ЗАТРАТ					 */
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 					 */"бу направления"
/*ПРОЧЕЕ 							 */
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */
/*СТАТЬИ							  */@RELATIVE("ПОЛНАЯ СЕБЕСТОИМОСТЬ",0)
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД							  */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 							  */{ВЕРСИЯ}
/*ГОД 								  */{ГОД}
/*ПРОДУКЦИЯ 						  */
/*ПОКАЗАТЕЛИ 						   */"Сумма","Кол-во"
/*МВЗ 									*/@RELATIVE("ККЦ",0)
)

FIX(
/*ПРОДУКЦИЯ 						  */@RELATIVE("Всего по продукции",0),"ПРОДУКЦИЯ ТЧМ и ТЧМС"	
/*ВИД ЗАТРАТ 						  */@RELATIVE("Всего по видам затрат",0),"ВИДЫ ЗАТРАТ ТЧМ И ТЧМС"
/*ПРОЧЕЕ 							  */@RELATIVE("Итого по прочим справочникам",0),"Прочие справочники ТЧМ И ТЧМС"
/*ЭЛЕМЕНТЫ_ЗАТРАТ					  */"ЭЛЕМЕНТЫ ЗАТРАТ ТЧМ И ТЧМС"
/*МВЗ ПОЛУЧАТЕЛЬ 					  */@RELATIVE("Итого по МВЗ (пол-ль)",0),"МВЗ получатели"
)
CLEARBLOCK ALL;

ENDFIX
ENDFIX]]></script>
    </rule>
  </rules>
  <components></components>
</HBRRepo>
<?xml version="1.0" encoding="UTF-8"?>
<HBRRepo>
  <variables>
    <variable id="1" name="ГОД" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Year</property>
      <property name="prompt_text">Выберите Год</property>
      <property name="scope">ruleset</property>
      <value>FY18</value>
    </variable>
    <variable id="2" name="ВЕРСИЯ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Version</property>
      <property name="prompt_text">Выберите Версию</property>
      <property name="scope">ruleset</property>
      <value>Рабочая_1</value>
    </variable>
    <variable id="3" name="СЦЕНАРИЙ" product="Planning" type="member" usage="const">
      <property name="array_type">string</property>
      <property name="dimensionInputMode">type</property>
      <property name="dimensionType">Scenario</property>
      <property name="prompt_text">Выберите Сценарий</property>
      <property name="scope">ruleset</property>
      <value>Проект</value>
    </variable>
  </variables>
  <rulesets></rulesets>
  <rules>
    <rule id="1" name="2.1.4.Калькуляция ДЦ" product="Planning">
      <property name="description">Калькуляция продукции Доменного цеха</property>
      <property name="application">ТЧМ</property>
      <property name="plantype">Plan1</property>
      <property name="disabled">true</property>
      <property name="display_label">2.1.4.Калькуляция ДЦ</property>
      <property name="enablePostProcessing">false</property>
      <property name="enablePreProcessing">false</property>
      <variable_references>
        <variable_reference id="2" name="ВЕРСИЯ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.4.Калькуляция ДЦ</property>
          <property name="seq">1</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="3" name="СЦЕНАРИЙ">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.4.Калькуляция ДЦ</property>
          <property name="seq">2</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
        <variable_reference id="1" name="ГОД">
          <property name="hasvalue">true</property>
          <property name="hidden">false</property>
          <property name="rule_name">2.1.4.Калькуляция ДЦ</property>
          <property name="seq">3</property>
          <property name="type">3</property>
          <property name="useAsOverrideValue">false</property>
        </variable_reference>
      </variable_references>
      <script><![CDATA[SET AGGMISSG ON;
SET UPDATECALC OFF;
SET CREATEBLOCKONEQ OFF;
SET CREATENONMISSINGBLK OFF;
SET FRMLBOTTOMUP OFF;
SET REMOTECALC OFF;
SET CALCPARALLEL 1;
SET CALCTASKDIMS 1;
SET EMPTYMEMBERSETS ON;
SET FRMLRTDYNAMIC OFF;
SET MSG INFO;
/* Проверка корректности рассчитываемого среза данных */

FIX(
/* ВАЛЮТА							*/	"бу валюты"
/* ПЕРИОД							*/	"P0"
/* ГОД								*/	"No Year"
/* ВЕРСИЯ							*/	
/* СЦЕНАРИЙ							*/	
/* ЦФО								*/	"бу ЦФО"
/* МВЗ								*/	"бу МВЗ"
/* МВЗ ПОЛУЧАТЕЛЬ					*/	"бу МВЗ (пол-ль)"
/* СЧЕТА БАЛАНСА					*/	"80_Увеличение"
/* СТАТЬИ							*/	
/* ПОКАЗАТЕЛИ						*/	"Сумма"
/* ВИД ЗАТРАТ						*/	"бу видов затрат"
/* ПРОДУКЦИЯ						*/	"бу вида продукции"
/* КОНТРАГЕНТЫ						*/	"бу контрагента"
/* НАПРАВЛЕНИЕ	*/	"бу направления"
/* ЭЛЕМЕНТЫ_ЗАТРАТ					*/	"бу элемента затрат"
/* ПРОЧЕЕ							*/	"бу прочих справочников"

)
  SET CREATENONMISSINGBLK ON;

  
  var ErrFlagScenario=0;
  var ErrFlagVersion=0;
  var NextM=2;
  /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА СЦЕНАРИЯ */
  FIX(/* Сценарий */ {СЦЕНАРИЙ} AND @LIST(&ОТКРЫТЫЕ_СЦЕНАРИИ))
    FIX(
    /* Сценарий */ 
    /* Версия   */ "Рабочая 1"
    )
     "бу статьи" (
     IF (ErrFlagScenario==0)
            ErrFlagScenario=1;
     ENDIF
     );

    ENDFIX
  ENDFIX

   /* ПРОВЕРКА КОРРЕКТНОСТИ ВЫБОРА ВЕРСИИ */
  FIX(/* Версия  */ {ВЕРСИЯ} AND @LIST(&ОТКРЫТЫЕ_ВЕРСИИ))
    FIX(
    /* Сценарий */ "Проект"
    /* Версия   */ 
    )
     "бу статьи" (
     IF (ErrFlagVersion==0)
            ErrFlagVersion=1;
     ENDIF
     );
    ENDFIX
  ENDFIX

  /* ВЫВОД СООБЩЕНИЙ О НЕКОРРЕКТНОМ СРЕЗЕ */
  FIX(
  /* Сценарий     */ "Проект"
  /* Версия       */ "Рабочая 1"
  )

   "бу статьи" (
    IF (ErrFlagScenario==0)
       @RETURN("Выбран сценарий, закрытый для расчета. Расчет не произведен.",ERROR);
    ENDIF
    IF (ErrFlagVersion==0)
       @RETURN("Выбрана версия, закрытая для расчета. Расчет не произведен.",ERROR);
    ENDIF
    )

   ENDFIX
ENDFIX
SET CREATENONMISSINGBLK OFF;
FIX(
/*ЭЛЕМЕНТЫ ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 					*/"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */
/*СТАТЬИ							  */
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД								 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 								 */{ВЕРСИЯ}
/*ГОД 								 	 */{ГОД}
/*ПРОДУКЦИЯ 							 */"Расходы по десульфурации чугуна"
/*ПОКАЗАТЕЛИ 						     */
/*МВЗ 									 */"УДЧ"
)
FIX(
/*Статья							*/"Кол-во с учетом годного выхода."
/*ВИД ЗАТРАТ						*/"бу видов затрат"
)

SET CREATENONMISSINGBLK ON;

/*Переносим кол-во из ПП */
"Кол-во"(
"бу видов затрат"->"Доменные печи"->"бу контрагента"->"бу направления"->"Чугун"->"бу прочих справочников"->"ПТО"->"бу элемента затрат"->"бу статьи"->"20_Выбытие"->"бу МВЗ (пол-ль)"->"Кол-во десульфурированного чугуна"->"RUR";
)
SET CREATENONMISSINGBLK OFF;
ENDFIX
ENDFIX
FIX(
/*ЭЛЕМЕНТЫ ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 					*/"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */
/*СТАТЬИ							  */
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД								 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 								 */{ВЕРСИЯ}
/*ГОД 								 	 */{ГОД}
/*ПРОДУКЦИЯ 							 */"Расходы по разливке чугуна"
/*ПОКАЗАТЕЛИ 						     */
/*МВЗ 									 */"Уч разливочных машин"
)
FIX(
/*Статья							*/"Кол-во с учетом годного выхода."
/*ВИД ЗАТРАТ						*/"бу видов затрат"
)

SET CREATENONMISSINGBLK ON;

/*Переносим кол-во из ПП */
"Кол-во"(
"бу видов затрат"->"Доменные печи"->"бу контрагента"->"бу направления"->"Чугун"->"бу прочих справочников"->"ПТО"->"бу элемента затрат"->"бу статьи"->"20_Выбытие"->"бу МВЗ (пол-ль)"->"Кол-во разлитого чугуна"->"RUR";
)
SET CREATENONMISSINGBLK OFF;
ENDFIX
ENDFIX
/*Срез Смметы для зачистки*/
FIX(
/*ЭЛЕМЕНТЫ_ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 						*/"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */@REMOVE(@RELATIVE("Итого по видам затрат",0),@LIST("ФОТ.", "Страховые взносы","Разработка грунта","Водный налог","Расчеты по договорам за водопользование"))
/*СТАТЬИ							  */@RELATIVE("ПОЛНАЯ СЕБЕСТОИМОСТЬ",0),"Кол-во с учетом годного выхода."
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД								 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 								 */{ВЕРСИЯ}
/*ГОД 								 	 */{ГОД}
/*ПРОДУКЦИЯ 							 */@RELATIVE("Всего по продукции",0) and @RELATIVE("Чугун",0)
/*ПОКАЗАТЕЛИ 						     */"Цена","Кол-во с учетом годного выхода"
/*МВЗ 									 */
)
FIXPARALLEL(8,@IDESCENDANTS("Доменные печи"))
CLEARBLOCK ALL;
ENDFIXPARALLEL
ENDFIX
/*Агрегируем цены с 6.14*/
FIX(
/*ПРОЧЕЕ						*/"бу прочих справочников"
/*ПРОДУКЦИЯ                     */"бу вида продукции"
/*НАПРАВЛЕНИЕ       			*/"бу направления"
/*ЭЛЕМЕНТЫ_ЗАТРАТ               */"бу элемента затрат"
/*МВЗ ПОЛУЧАТЕЛЬ                */"бу МВЗ (пол-ль)"
/*ВАЛЮТА                        */"RUR"
/*ПЕРИОД                        */@RELATIVE("Всего год",0)
/*КОНТРАГЕНТЫ                   */
/*ВЕРСИЯ                        */{ВЕРСИЯ}
/*ГОД                           */{ГОД}
/*МВЗ                           */@ILDESCENDANTS(@LIST(@IANCESTORS("Доменные печи",4),"бу МВЗ")) and  @RELATIVE("Всего по МВЗ",0)
/*СЦЕНАРИЙ                      */{СЦЕНАРИЙ}
/*ВИД ЗАТРАТ                    */"Электроэнергия покупная",
								"Водород",
								"Газ природный",
								"Газ природный (осн. объем)",
								"Газ природный (биржа)",
								"Техническое обслуживание газовых сетей",
								"Вода",
								"Стоки",
								"Аргон","Аргон.",
								"Кислород технологический",
								"Пар покупной","Азот газообразный","Техническая вода","Техническая вода подготовленная.","Питьевая вода","Сжатый воздух в целом"
/*ЦФО                           */
/*СТАТЬИ                        */"Энергоресурсы_", "Топливо.","Прочие выплаты (гр)"
/*ПОКАЗАТЕЛИ                    */"Кол-во","Сумма"
/*СЧЕТА БАЛАНСА                 */"60_Начисление без НДС"
)

FIX(
/*ЦФО                           */"ОСиТ","Коммерческая служба", "Упр по реал-ции прод-ции"
/*КОНТРАГЕНТЫ                   */
)
AGG("КОНТРАГЕНТЫ");/*"Контрагенты ТЧМ и ТЧМС"*/
ENDFIX

FIX(
/*ЦФО                           */
/*КОНТРАГЕНТЫ                   */"Контрагенты ТЧМ и ТЧМС"
)
AGG("ЦФО");/*"Центры финансовой ответсвенности"*/
ENDFIX

ENDFIX



FIX(
/*НАПРАВЛЕНИЕ          */
/*ПРОДУКЦИЯ                         */
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                      */"бу элемента затрат"
/*ЦФО                               */
/*ВАЛЮТА                            */"RUR","бу валюты"
/*КОНТРАГЕНТЫ                         */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*МВЗ                               */
/*СЧЕТА БАЛАНСА                      */
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */@RELATIVE("Итого по видам затрат",0)
/*СТАТЬИ                            */
/*ПЕРИОД                            */@RELATIVE("Итого год",0),"P0"
/*ПОКАЗАТЕЛИ                         */
)
/*Агрегируем цены 6-го блока*/

FIX(
/*ПРОДУКЦИЯ                         */"бу вида продукции"
/*МВЗ                               */"ТЧМ в целом","ТЧМС в целом"
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"10_Остаток на начало","10_Поступление","10_Остаток на конец"
/*СТАТЬИ                            */@CHILDREN("Отток денежных средств по текущей деятельности"),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Сумма","Кол-во"
)
FIX(
/*ЦФО                               */@RELATIVE("Итого по ЦФО",0)
)
AGG(КОНТРАГЕНТЫ);
ENDFIX

FIX(
/*КОНТРАГЕНТЫ                        */"Контрагенты ТЧМ и ТЧМС"
)
AGG(ЦФО);
ENDFIX
ENDFIX


/*Агрегируем нормативы */

FIX(
/*ПРОДУКЦИЯ                         */@RELATIVE("Всего по продукции",0) and @RELATIVE("Чугун",0)
/*МВЗ                               */@RELATIVE("Доменные печи",0)
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во","Норма на ед.","Нормы сырья и топлива на 1 ед. измер.","Выход шлака на 1 т чугуна"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
AGG(ЦФО);
ENDFIX

/*Агрегируем ПП */

FIX(
/*ПРОДУКЦИЯ                         */@RELATIVE("Всего по продукции",0) and @RELATIVE("Чугун",0)
/*МВЗ                               */@RELATIVE("Доменные печи",0)
/*НАПРАВЛЕНИЕ          */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*СЧЕТА БАЛАНСА                      */"20_Начисление","20_Выбытие","43_Производство ГП"
/*СТАТЬИ                            */"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во с учетом годного выхода"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
FIX(
/*НАПРАВЛЕНИЕ                         */@RELATIVE("Направления",0)
/*МВЗ ПОЛУЧАТЕЛЬ                      */@RELATIVE("Итого по МВЗ (пол-ль)",0)
)
AGG(ЦФО);
ENDFIX

FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*НАПРАВЛЕНИЕ          */
/*МВЗ ПОЛУЧАТЕЛЬ                      */@RELATIVE("Итого по МВЗ (пол-ль)",0)
)
AGG("НАПРАВЛЕНИЕ");
ENDFIX

FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*НАПРАВЛЕНИЕ                         */"Направления"
/*МВЗ ПОЛУЧАТЕЛЬ                      */
)
AGG("МВЗ ПОЛУЧАТЕЛЬ");
ENDFIX


ENDFIX
ENDFIX

/*Расчет основных показателей*/

FIX(
/*НАПРАВЛЕНИЕ          				*/
/*ПРОДУКЦИЯ                         */@REMOVE(@LIST(@ILDESCENDANTS("Чугун"),@RDESCENDANTS("Чугун")),@LIST("Условный газ","Кислород газообразный в баллонах.","Азот газообразный в баллонах_","бу вида продукции"))
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                   */"бу элемента затрат"
/*ЦФО                               */
/*ВАЛЮТА                            */
/*КОНТРАГЕНТЫ                         */"бу контрагента"
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*МВЗ                               */@RELATIVE("Доменные печи",0)
/*СЧЕТА БАЛАНСА                      */
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */
/*СТАТЬИ                            */
/*ПЕРИОД                            */@RELATIVE("Итого год",0)
/*ПОКАЗАТЕЛИ                         */
)

/*Создаем блоки из нормативов для количества*/
FIX(
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*ВИД ЗАТРАТ                         */@REMOVE(@RELATIVE("Итого по видам затрат",0),@LIST("Разработка грунта", "Потери эл. энергии"))
/*СТАТЬИ                            */
) 
FIXPARALLEL(8,@DESCENDANTS("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ"))


DATACOPY "Кол-во"->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";

DATACOPY "Кол-во"->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";


DATACOPY "Кол-во"->"бу направления"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу направления"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу направления"->"RUR"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу направления"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";

DATACOPY "Кол-во"->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Норма на ед."->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Нормы сырья и топлива на 1 ед. измер."->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";
DATACOPY "Выход шлака на 1 т чугуна"->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности" to "Кол-во"->"бу направления"->"RUR"->"ПЭО";

ENDFIXPARALLEL

ENDFIX

/*Создаем блоки из нормативов для "Кол-во с учетом годного выхода"*/
FIX(
/*ВИД ЗАТРАТ                         */"бу видов затрат"
/*СТАТЬИ                            */
) 
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";


DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"20_Выбытие" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";


DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";

DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";
DATACOPY "Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"43_Производство ГП" to "Кол-во"->"Кол-во с учетом годного выхода."->"бу направления"->"бу МВЗ (пол-ль)"->"RUR"->"ПЭО"->"20_Начисление";


ENDFIX




FIX(
/*СЧЕТА БАЛАНСА                      */@RELATIVE("Начисление",0)
/*ВАЛЮТА                            */"RUR"
/*ЦФО                               */"ПЭО"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*НАПРАВЛЕНИЕ         				 */"бу направления"
/*ВИД ЗАТРАТ                         */
/*СТАТЬИ                            */
)


FIX(
/*ВИД ЗАТРАТ                         */"бу видов затрат"
/*СТАТЬИ                            */"Кол-во с учетом годного выхода."
)
/*Перенос "Кол-во с учетом годного выхода"*/
"Кол-во"(
"Кол-во" = #missing;
"Кол-во"=
"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"20_Выбытие"          
+"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"20_Выбытие"               
+"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"бу валюты"->"Центры финансовой ответсвенности"->"43_Производство ГП"
+"Кол-во с учетом годного выхода"->"бу статьи"->"Направления"->"МВЗ получатели"->"RUR"->"Центры финансовой ответсвенности"->"43_Производство ГП"          

;)





ENDFIX

FIX(
/*ВИД ЗАТРАТ                         */
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0)
)
FIXPARALLEL(8,@DESCENDANTS("Итого по видам затрат"))
/*Расчет количества по нормативу*/


"Кол-во"(
IF( ( @ISDESC("№17. Энергоцех") and @ISMBR("Разработка грунта"))
OR ( @ISMBR("Уч передачи электроэнергии") and @ISMBR(@LIST("Электроэнергия покупная",/*"Электроэнергия ТЭЦ-ПВС",*/"Потери эл. энергии" ))) 
/*or ( NOT @ISMBR("Уч пр-ва условного газа") and NOT @ISMBR(@LIST("Электроэнергия","Пар","Техническая вода")))*/  ) 
/*"Кол-во"=#missing;*/
"Кол-во";
ELSE 
"Кол-во"=
/*норматив*/
("Норма на ед."->"бу напр-я списания"->"бу валюты"->"Центры финансовой ответсвенности"
+"Норма на ед."->"бу напр-я списания"->"RUR"->"Центры финансовой ответсвенности"
+"Норма на ед."->"RUR"->"Центры финансовой ответсвенности"
+"Норма на ед."->"бу валюты"->"Центры финансовой ответсвенности"
/*Добавил для Аглоцеха*/
+"Нормы сырья и топлива на 1 ед. измер."->"бу направления"->"RUR"->"Центры финансовой ответсвенности"/1000
)
/*количество из ПП*/
*
(
"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат")
;

ENDIF)


"Цена"(
IF("Кол-во"+0>0)
IF( NOT @ISMBR("Отходы производства") and NOT @ISDESC("Возвратные отходы") )
IF(@ISMBR("Январь"))
/*цены на возвратные отходы из формы 6.08 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Цена"->"RUR"
+


/*цены с 6.04.03*/
/*вместо динамика Цена с тарифом. прописываем ее формулу*/
(
@SUMRANGE("Сумма"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Сумма"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
@SUMRANGE("Кол-во"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Кол-во"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)
+
/*цены с 6.14*/
/*цена в целом */
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/*зануляем цену если цена есть для конкретного МВЗ*/
 *(1-@POWER(1,@SUMRANGE("Цена"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))))
+
/*цена по конкретному мвз*/
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
;
ELSE 
/*цены на возвратные отходы из формы 6.08 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Цена"->"RUR"

+
/*цены с 6.04.03*/
(
@PRIOR("Сумма"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"->"Отток денежных средств по текущей деятельности")
+ @PRIOR("Сумма"->"бу статьи"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности")

+@SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
 @PRIOR("Кол-во"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"->"Отток денежных средств по текущей деятельности")
+ @PRIOR("Кол-во"->"бу статьи"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности")

+@SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)
+
/*цены с 6.14*/
/*цена в целом */
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/*зануляем цену если цена есть для конкретного МВЗ*/
*(1-@POWER(1,@SUMRANGE("Цена"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))))
+
/*цена по конкретному мвз*/
 @SUMRANGE("Сумма"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))
/@SUMRANGE("Кол-во"->"60_Начисление без НДС"->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@RELATIVE("Отток денежных средств по текущей деятельности",0))

;
ENDIF
ELSE 
/*цены на возвратные отходы из формы 6.08 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Цена"->"RUR"
+
/*цены на возвратные отходы из формы 1.6.1 */
@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"Коммерческая служба"->"бу элемента затрат"->"бу статьи"->"бу счета баланса"->"бу МВЗ (пол-ль)"->"Цена"->"RUR";
ENDIF
ELSE 
"Цена" = #missing;
ENDIF;)




"Сумма"(
IF(
/*отключаем расчет сумма для след ВЗ и МВЗ ->Продкция*/
NOT @ISMBR("Разработка грунта"->"Уч транспортировки и очистки промливневых стоков"->"Прием пром-ливневых стоков")
AND NOT @ISMBR("Разработка грунта"->"Уч по разработке шлама аглодоменного"->"Шлам по ТУ 14-127-330.")
AND NOT @ISMBR("Разработка грунта"->"Уч питьевой воды"->"Питьевая вода.")
AND NOT @ISMBR("Разработка грунта"->"Уч перекачки и очистка хоз.-бытовых стоков"->"Хоз.-бытовые стоки")
AND NOT @ISMBR("Разработка грунта"->"Уч технической воды"->"Техническая вода.")
)

/*лоика следующая по зачистке сумм
Если Кол-во на ед, которая расчитана в прошлый раз <> 0, 
значит Сумма расчитана как Кол-во  * Цена
*/
IF("Кол-во на ед"!=#missing) 
"Сумма"="Цена"*"Кол-во";
ENDIF
ENDIF
;)

/*разносим "Кол-во с учетом годного выхода для расчета Кол-во и суммы  на ед в динамике */
"Кол-во с учетом годного выхода"(
	IF("Кол-во"!=#missing)
		"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";
	ELSE
		#missing;
ENDIF)

"Кол-во на ед"("Кол-во"/"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";)

"Сумма на ед"("Сумма"/"Кол-во"->"Кол-во с учетом годного выхода."->"бу видов затрат";)

"Структура"("Сумма"/"Сумма"->"СЕБЕСТОИМОСТЬ ТОВАРНОЙ ПРОДУКЦИИ FCA"->"бу видов затрат";)

ENDFIXPARALLEL
ENDFIX
ENDFIX


ENDFIX

/*Удаляем не нужные агрегаты*/
FIX(
/*НАПРАВЛЕНИЕ          */
/*ПРОДУКЦИЯ                         */"бу вида продукции"
/*ПРОЧЕЕ                            */"бу прочих справочников"
/*ЭЛЕМЕНТЫ_ЗАТРАТ                      */"бу элемента затрат"
/*ЦФО                               */
/*ВАЛЮТА                            */"RUR","бу валюты"
/*КОНТРАГЕНТЫ                         */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*МВЗ                               */
/*СЧЕТА БАЛАНСА                      */
/*СЦЕНАРИЙ                            */{СЦЕНАРИЙ}
/*ВЕРСИЯ                            */{ВЕРСИЯ}
/*ГОД                               */{ГОД}
/*ВИД ЗАТРАТ                         */@RELATIVE("Всего по видам затрат",0)
/*СТАТЬИ                            */
/*ПЕРИОД                            */@RELATIVE("Итого год",0),"P0"
/*ПОКАЗАТЕЛИ                         */
)
/*6-го блока*/

FIX(
/*МВЗ                               */"ТЧМ в целом","ТЧМС в целом"
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"10_Остаток на начало","10_Поступление","10_Остаток на конец"
/*СТАТЬИ                            */@CHILDREN("Отток денежных средств по текущей деятельности"),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Сумма","Кол-во"
)
FIX(
/*ЦФО                               */
/*КОНТРАГЕНТЫ                        */"Контрагенты ТЧМ и ТЧМС"
)
FIXPARALLEL(8,@IDESCENDANTS("Центры финансовой ответсвенности"))

CLEARBLOCK ALL;


ENDFIXPARALLEL
ENDFIX
ENDFIX


/*нормативы */

FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*МВЗ                               */
/*НАПРАВЛЕНИЕ                         */"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ                      */"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*СТАТЬИ                            */@RELATIVE("ЦЕХОВАЯ СЕБЕСТОИМОСТЬ",0),"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во","Норма на ед.","Нормы сырья и топлива на 1 ед. измер.","Выход шлака на 1 т чугуна"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
FIXPARALLEL(8,@IDESCENDANTS("Доменные печи"))
CLEARBLOCK ALL;
ENDFIXPARALLEL
ENDFIX

/* ПП */

FIX(
/*МВЗ                               */
/*НАПРАВЛЕНИЕ          */
/*МВЗ ПОЛУЧАТЕЛЬ                      */
/*СЧЕТА БАЛАНСА                      */"20_Начисление","20_Выбытие","43_Производство ГП"
/*СТАТЬИ                            */"бу статьи"
/*ПОКАЗАТЕЛИ                         */"Кол-во с учетом годного выхода"
/*КОНТРАГЕНТЫ                        */"бу контрагента"
)
FIX(
/*ЦФО                               */"Центры финансовой ответсвенности"
/*НАПРАВЛЕНИЕ                         */@RELATIVE("Направления",0),"Направления"
/*МВЗ ПОЛУЧАТЕЛЬ                      */@RELATIVE("Итого по МВЗ (пол-ль)",0),"МВЗ получатель"
)
FIXPARALLEL(8,@IDESCENDANTS("Доменные печи"))
CLEARBLOCK ALL;
ENDFIXPARALLEL
ENDFIX


ENDFIX 
ENDFIX 


/*Удаляем агрегот для цены с 6.14*/
FIX(
/*ПРОЧЕЕ						*/"бу прочих справочников"
/*ПРОДУКЦИЯ                     */"бу вида продукции"
/*НАПРАВЛЕНИЕ       			*/"бу направления"
/*ЭЛЕМЕНТЫ_ЗАТРАТ               */"бу элемента затрат"
/*МВЗ ПОЛУЧАТЕЛЬ                */"бу МВЗ (пол-ль)"
/*ВАЛЮТА                        */"RUR"
/*ПЕРИОД                        */@RELATIVE("Всего год",0)
/*КОНТРАГЕНТЫ                   */
/*ВЕРСИЯ                        */{ВЕРСИЯ}
/*ГОД                           */{ГОД}
/*МВЗ                           */@RELATIVE("Всего по МВЗ",0)
/*СЦЕНАРИЙ                      */{СЦЕНАРИЙ}
/*ВИД ЗАТРАТ                    */"Электроэнергия покупная",
								"Водород",
								"Газ природный",
								"Газ природный (осн. объем)",
								"Газ природный (биржа)",
								"Техническое обслуживание газовых сетей",
								"Вода",
								"Стоки",
								"Аргон",
								"Кислород технологический",
								"Пар покупной","Азот газообразный","Техническая вода","Техническая вода подготовленная.","Питьевая вода"
/*ЦФО                           */
/*СТАТЬИ                        */"Энергоресурсы_", "Топливо.","Прочие выплаты (гр)"
/*ПОКАЗАТЕЛИ                    */"Кол-во","Сумма"
/*СЧЕТА БАЛАНСА                 */"60_Начисление без НДС"
)

FIX(
/*ЦФО                           */"ОСиТ","Коммерческая служба", "Упр по реал-ции прод-ции","Центры финансовой ответсвенности"
/*КОНТРАГЕНТЫ                   */"Контрагенты ТЧМ и ТЧМС"
)
CLEARBLOCK ALL;
ENDFIX

ENDFIX
/*  Проволока ПП,
   Перенос Проволоки ПП в МВЗ УДЧ на другую продукцию и очистка с Доменного цеха и Чугуна */

FIX(
/*ЭЛЕМЕНТЫ ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 			         */"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*МВЗ ПОЛУЧАТЕЛЬ 					 */"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							 */"RUR"
/*ВИД ЗАТРАТ 						 */
/*СТАТЬИ							 */
/*СЦЕНАРИЙ							 */{СЦЕНАРИЙ}
/*ПЕРИОД							 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 							 */{ВЕРСИЯ}
/*ГОД 								 */{ГОД}
/*ПРОДУКЦИЯ 						 */
/*ПОКАЗАТЕЛИ 						 */
/*МВЗ 								 */
)

    
	/* Проволока ПП */
	FIX(
	/*МВЗ 								*/"УДЧ"
	/*Статья							*/"Сырье и основные материалы."
	/*ВИД ЗАТРАТ						*/"Проволока ПП"
	/*ПОКАЗАТЕЛИ 						*/
    /*ПРОДУКЦИЯ 						*/"Расходы по десульфурации чугуна"
	)
    
    SET CREATENONMISSINGBLK ON;
    
    		"Кол-во на ед" = @SUMRANGE("Доменные печи"->"Кол-во на ед",@RELATIVE("Чугун",0));
    		"Сумма" = @SUMRANGE("Доменные печи"->"Сумма",@RELATIVE("Чугун",0));            
			"Кол-во" = @SUMRANGE("Доменные печи"->"Кол-во",@RELATIVE("Чугун",0));           
            "Цена" = "ТЧМ в целом"->"Итого по контрагентам"->"бу вида продукции"->"ОСиТ"->"Материалы на технологические цели."->"10_Списание"->"Цена с тарифом.";
            "Сумма" = "Кол-во" * "Цена";
            
    SET CREATENONMISSINGBLK OFF;
    
	ENDFIX
    
     FIX(
	/*МВЗ 								*/@RELATIVE("Доменные печи",0)
	/*Статья							*/"Сырье и основные материалы."
	/*ВИД ЗАТРАТ						*/"Проволока ПП"
	/*ПОКАЗАТЕЛИ 						*/
    /*ПРОДУКЦИЯ 						 */@RELATIVE("Чугун",0)
	)
        "Сумма" (
        IF (@ISDESC("Доменные печи"))
            "Сумма" = #MISSING;  
            "Кол-во" = #MISSING;
        ENDIF
        )
	ENDFIX	
      
ENDFIX
FIX(
/*НАПРАВЛЕНИЕ 			*/
/*ПРОДУКЦИЯ 								*/
/*ПРОЧЕЕ 									*/"бу прочих справочников"
/*ЭЛЕМЕНТЫ ЗАТРАТ 							*/"бу элемента затрат"
/*ЦФО 										*/
/*ВАЛЮТА 									*/"RUR","бу валюты"
/*КОНТРАГЕНТЫ 								*/
/*МВЗ ПОЛУЧАТЕЛЬ 							*/
/*МВЗ 										*/
/*СЧЕТА БАЛАНСА 							*/
/*СЦЕНАРИЙ 									*/{СЦЕНАРИЙ}
/*ВЕРСИЯ 									*/{ВЕРСИЯ}
/*ГОД 										*/{ГОД}
/*ВИД ЗАТРАТ 								*/@RELATIVE("Итого по видам затрат",0)
/*СТАТЬИ 									*/
/*ПЕРИОД 									*/@RELATIVE("Итого год",0),"P0"
/*ПОКАЗАТЕЛИ 								*/
)
/*Агрегируем цены 6-го блока*/

FIX(
/*ПРОДУКЦИЯ 								*/"бу вида продукции"
/*МВЗ 										*/"ТЧМ в целом","ТЧМС в целом"
/*НАПРАВЛЕНИЕ 								*/"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ 							*/"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА 							*/"10_Остаток на начало","10_Поступление","10_Остаток на конец"
/*СТАТЬИ 									*/@CHILDREN("Отток денежных средств по текущей деятельности"),"бу статьи"
/*ПОКАЗАТЕЛИ 								*/"Сумма","Кол-во"
)
FIX(
/*ЦФО 										*/@RELATIVE("Итого по ЦФО",0)
)
AGG(КОНТРАГЕНТЫ);
ENDFIX

FIX(
/*КОНТРАГЕНТЫ								*/"Контрагенты ТЧМ и ТЧМС"
)
AGG(ЦФО);
ENDFIX
ENDFIX
ENDFIX




FIX(
/*ЭЛЕМЕНТЫ ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 					*/"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*МВЗ ПОЛУЧАТЕЛЬ 					 */	"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							  */"RUR"
/*ВИД ЗАТРАТ 						  */
/*СТАТЬИ							  */
/*СЦЕНАРИЙ							  */{СЦЕНАРИЙ}
/*ПЕРИОД								 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 								 */{ВЕРСИЯ}
/*ГОД 								 	 */{ГОД}
/*ПРОДУКЦИЯ 							 */@RELATIVE("Чугун",0)
/*ПОКАЗАТЕЛИ 						     */
/*МВЗ 									 */@REMOVE(@RELATIVE("Доменные печи",0),"ОПР ДП")
)
FIX(
/*Статья							*/"Отходы производства"
/*ВИД ЗАТРАТ						*/"Графитовый чугунный скрап","Скрап с разливочных машин","Пыль колошниковая","Отсев кокса мелкофракционный","Отработанная леточная масса","Горелая земля доменного цеха","Материал железосодержащий АС","Шлам аглодоменный (ДЦ)"
)

SET CREATENONMISSINGBLK ON;

/*Распределяем пропорционально кол-ву с учетом годного выхода  */

"Кол-во"(
"Отходы производства"->"бу прочих справочников"->"бу вида продукции"->"ОПР ДП"->"бу элемента затрат"->"RUR"->"ПТО"->"20_Выбытие"->"бу контрагента"->"ТЧМ Итого (пол-ль)"->"Цехи п-п (сч 20;23;26)"->"Кол-во"
*"бу видов затрат"->"бу контрагента"->"Тов. пр-ция (сч 43)"->"бу прочих справочников"->"ПТО"->"бу элемента затрат"->"бу статьи"->"20_Выбытие"->"бу МВЗ (пол-ль)"->"Кол-во с учетом годного выхода"->"RUR"
/"Доменные печи"->"Чугун"->"бу видов затрат"->"бу контрагента"->"Тов. пр-ция (сч 43)"->"бу прочих справочников"->"ПТО"->"бу элемента затрат"->"бу статьи"->"20_Выбытие"->"бу МВЗ (пол-ль)"->"Кол-во с учетом годного выхода"->"RUR";
;)

"Цена"(
IF("Кол-во"+0>0)
IF(@ISMBR("Январь"))
"Цена"->"ТЧМ в целом"->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"RUR"
+
/*вместо динамика Цена с тарифом. прописываем ее формулу*/
(
@SUMRANGE(/*"P0"->*/"Сумма"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+/*"P0"->*/"Сумма"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
@SUMRANGE("Кол-во"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Кол-во"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
);
ELSE 
	
"Цена"->"ТЧМ в целом"->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"RUR"
+ 
(
@SUMRANGE(@MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Сумма"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+ @MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Сумма"->"бу статьи"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+@SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
 @SUMRANGE(@MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Кол-во"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+ @MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Кол-во"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+@SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
);
ENDIF
ELSE 
"Цена" = #missing;
ENDIF;)



"Сумма"(
IF("Цена"+0<>0 and "Кол-во"+0<>0)
"Сумма"="Цена"*"Кол-во";
ENDIF;)


ENDFIX

FIX(
/*Статья							*/"ПОПУТНАЯ ПРОДУКЦИЯ"
)
FIX(
/*ВИД ЗАТРАТ						*/"Шлак жидкий на щебень.","Шлак на грануляцию.","Ковшевые остатки"
)

/*Распределяем пропорционально шихте  */


"Кол-во"(
"бу прочих справочников"->"бу вида продукции"->"ОПР ДП"->"бу элемента затрат"->"RUR"->"ПТО"->"20_Выбытие"->"бу контрагента"->"ТЧМ Итого (пол-ль)"->"Цехи п-п (сч 20;23;26)"->"Кол-во"
*
"Металлошихта"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Сырье и основные материалы."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
/
"Доменные печи"->"Чугун"->"Металлошихта"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Сырье и основные материалы."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"

;)

/*Распределяем пропорционально шихте и коксу  

"Кол-во"(
"бу прочих справочников"->"бу вида продукции"->"ОПР ДП"->"бу элемента затрат"->"RUR"->"ПТО"->"20_Выбытие"->"бу контрагента"->"ТЧМ Итого (пол-ль)"->"Цехи п-п (сч 20;23;26)"->"Кол-во"
*
("Металлошихта"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Сырье и основные материалы."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Кокс влажный скиповой"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Коксовый орех"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Коксовая мелочь с РВО"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Коксовая мелочь с печей"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во")
/
("Доменные печи"->"Чугун"->"Металлошихта"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Сырье и основные материалы."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Доменные печи"->"Чугун"->"Кокс влажный скиповой"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Доменные печи"->"Чугун"->"Коксовый орех"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Доменные печи"->"Чугун"->"Коксовая мелочь с РВО"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
+"Доменные печи"->"Чугун"->"Коксовая мелочь с печей"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Топливо технологическое."->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
)
;)




*/






/*Распределяем пропорционально очистке газа, которая в нормативах уже пересчитана пропорц-но выходу доменного газа  */

ENDFIX

FIX(
/*ВИД ЗАТРАТ						*/"Газ доменный другим цехам.","Газ доменный на каупера.","Потери газа."
)
"Кол-во"(
"бу прочих справочников"->"бу вида продукции"->"ОПР ДП"->"бу элемента затрат"->"RUR"->"ПТО"->"20_Выбытие"->"бу контрагента"->"ТЧМ Итого (пол-ль)"->"Цехи п-п (сч 20;23;26)"->"Кол-во"
*"Очистка газа"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Энергозатраты по переделу"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
/
"Доменные печи"->"Чугун"->"Очистка газа"->"бу контрагента"->"бу направления"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"Энергозатраты по переделу"->"20_Начисление"->"бу МВЗ (пол-ль)"->"Кол-во"
;)
ENDFIX

"Цена"(
IF("Кол-во"+0>0)
IF(@ISMBR("Январь"))
"Цена"->"ТЧМ в целом"->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"RUR"
+
/*вместо динамика Цена с тарифом. прописываем ее формулу*/
(
@SUMRANGE(/*"P0"->*/"Сумма"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+/*"P0"->*/"Сумма"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
@SUMRANGE("Кол-во"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Кол-во"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+ @SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
);
ELSE 
"Цена"->"ТЧМ в целом"->"бу контрагента"->"бу направления"->"бу вида продукции"->"бу прочих справочников"->"ПЭО"->"бу элемента затрат"->"ПОПУТНАЯ ПРОДУКЦИЯ"->"20_Начисление"->"бу МВЗ (пол-ль)"->"RUR"
+
(
@SUMRANGE(@MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Сумма"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+ @MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Сумма"->"бу статьи"->"10_Остаток на конец"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+@SUMRANGE("Сумма"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Сумма"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
)/
(
 @SUMRANGE(@MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Кол-во"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+ @MEMBER(@PREVSIBLING(@CURRMBR("ПЕРИОД")))->"Кол-во"->"бу статьи"->"10_Остаток на начало"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"

+@SUMRANGE("Кол-во"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности",@CHILDREN("Отток денежных средств по текущей деятельности"))
+"Кол-во"->"бу статьи"->"10_Поступление"->@MEMBER(@CONCATENATE(@SUBSTRING(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)),0,@CalcMgrTextLength(@NAME(@ANCEST(@CURRMBR("МВЗ"),4)))-6)," в целом"))->"Контрагенты ТЧМ и ТЧМС"->"бу вида продукции"->"бу МВЗ (пол-ль)"->"Центры финансовой ответсвенности"
);
ENDIF
ELSE 
"Цена" = #missing;
ENDIF;)



"Сумма"(
IF("Цена"+0<>0 and "Кол-во"+0<>0)
"Сумма"="Цена"*"Кол-во";
ENDIF;)

ENDFIX


ENDFIX



/*Удаляем не нужные агрегаты*/
FIX(
/*НАПРАВЛЕНИЕ 			*/
/*ПРОДУКЦИЯ 								*/"бу вида продукции"
/*ПРОЧЕЕ 									*/"бу прочих справочников"
/*ЭЛЕМЕНТЫ ЗАТРАТ 							*/"бу элемента затрат"
/*ЦФО 										*/
/*ВАЛЮТА 									*/"RUR","бу валюты"
/*КОНТРАГЕНТЫ 								*/
/*МВЗ ПОЛУЧАТЕЛЬ 							*/
/*МВЗ 										*/
/*СЧЕТА БАЛАНСА 							*/
/*СЦЕНАРИЙ 									*/{СЦЕНАРИЙ}
/*ВЕРСИЯ 									*/{ВЕРСИЯ}
/*ГОД 										*/{ГОД}
/*ВИД ЗАТРАТ 								*/@RELATIVE("Всего по видам затрат",0)
/*СТАТЬИ 									*/
/*ПЕРИОД 									*/@RELATIVE("Итого год",0),"P0"
/*ПОКАЗАТЕЛИ 								*/
)
/*6-го блока*/

FIX(
/*МВЗ 										*/"ТЧМ в целом","ТЧМС в целом"
/*НАПРАВЛЕНИЕ 								*/"бу направления","бу напр-я списания"
/*МВЗ ПОЛУЧАТЕЛЬ 							*/"бу МВЗ (пол-ль)"
/*СЧЕТА БАЛАНСА 							*/"10_Остаток на начало","10_Поступление","10_Остаток на конец"
/*СТАТЬИ 									*/@CHILDREN("Отток денежных средств по текущей деятельности"),"бу статьи"
/*ПОКАЗАТЕЛИ 								*/"Сумма","Кол-во"
)
FIX(
/*ЦФО 										*/@RELATIVE("Итого по ЦФО",0),"Центры финансовой ответсвенности"
/*КОНТРАГЕНТЫ								*/"Контрагенты ТЧМ и ТЧМС"
)
CLEARBLOCK ALL;
ENDFIX
ENDFIX
ENDFIX
FIX(
/*ЭЛЕМЕНТЫ ЗАТРАТ					 */"бу элемента затрат"
/*ЦФО 						  		 */"ПЭО"
/*КОНТРАГЕНТЫ 						 */"бу контрагента"
/*НАПРАВЛЕНИЕ 	 			         */"бу направления"
/*ПРОЧЕЕ 							 */"бу прочих справочников"
/*СЧЕТА БАЛАНСА                      */"20_Начисление"
/*МВЗ ПОЛУЧАТЕЛЬ 					 */"бу МВЗ (пол-ль)"
/*ВАЛЮТА 							 */"RUR"
/*ВИД ЗАТРАТ 						 */
/*СТАТЬИ							 */
/*СЦЕНАРИЙ							 */{СЦЕНАРИЙ}
/*ПЕРИОД							 */@RELATIVE("Итого год",0)
/*ВЕРСИЯ 							 */{ВЕРСИЯ}
/*ГОД 								 */{ГОД}
/*ПРОДУКЦИЯ 						 */
/*ПОКАЗАТЕЛИ 						 */
/*МВЗ 								 */
)

    
	/* Проволока ПП */
	FIX(
	/*МВЗ 								*/"Установка придоменной грануляции шлака"
	/*Статья							*/"Сырье и основные материалы."
	/*ВИД ЗАТРАТ						*/"Шлак на грануляцию."
	/*ПОКАЗАТЕЛИ 						*/
    /*ПРОДУКЦИЯ 						*/"Граншлак"
	)
    
    SET CREATENONMISSINGBLK ON;
    
    		
    		"Сумма" = @SUMRANGE("Доменные печи"->"Сумма"->"Шлак на грануляцию."->"ПОПУТНАЯ ПРОДУКЦИЯ",@RELATIVE("Чугун",0));            
			"Кол-во" = @SUMRANGE("Доменные печи"->"Кол-во"->"Шлак на грануляцию."->"ПОПУТНАЯ ПРОДУКЦИЯ",@RELATIVE("Чугун",0));           
             
    SET CREATENONMISSINGBLK OFF;
    
	ENDFIX
    
    ENDFIX]]></script>
    </rule>
  </rules>
  <components></components>
</HBRRepo>